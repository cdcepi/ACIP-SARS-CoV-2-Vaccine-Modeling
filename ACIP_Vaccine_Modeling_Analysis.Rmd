---
title: "Modeling Strategies for the Initial Allocation of SARS-CoV-2 Vaccines"
author: "Jo Walker for the CDC COVID-19 Modeling Unit"
output:
  html_document:
    code_folding: hide
---

# Setup

**Load packages**

```{r, message = F}
library(knitr)
library(kableExtra)
library(RColorBrewer)
library(tidyverse)
```

**Load flumodels functions**

```{r, message = F}
# Replace "C:/Users/nxj1/Downloads/" with the location the "ACIP-Vaccine-Modeling" folder is saved to

PATH = "C:/Users/nxj1/Downloads/"
setwd(PATH)

flumodels.scripts = 
  paste0(PATH,"ACIP-Vaccine-Modeling/R/",list.files(paste0(PATH,"ACIP-Vaccine-Modeling/R")))

for(i in flumodels.scripts){source(i)}

load(paste0(PATH,"ACIP-Vaccine-Modeling/data/flumodels_data.rda"))

# US_Pop_2020: US census data for 2020, including population counts by age. Downloaded from https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/national/asrh/nc-est2019-alldata-r-file21.csv

US_Pop_2020 = read.csv("C:/Users/nxj1/Downloads/ACIP-Vaccine-Modeling/data/US_Population.csv")


library(readxl)

# reading in the raw, location-specific, US-projected POLYMOD matrices

ContactTypes = c("All Locations","Work","Home","School","OtherLocations")

US_Polymod_Raw = list()

Original.Polymod.AgeGroups = paste0("Age",seq(0,75,5),c(rep("to",15),"plus"),c(seq(4,74,5),""))

for(i in ContactTypes)
{
  
  
  US_Polymod_Raw[[i]] = read_excel(
    paste0(PATH,"ACIP-Vaccine-Modeling/Data/Polymod_Contacts_USA_Projection.xlsx"),
    sheet=i,
    col_names=Original.Polymod.AgeGroups)
}

original.Polymod.Ages = data.frame(AgeStart = seq(0,75,5),
                                   AgeEnd = c(seq(4,74,5),NA),
                                   row.names = Original.Polymod.AgeGroups
) %>% t() %>% data.frame()

original.Polymod.Fractions = getPopulationFractions(ages = seq(4,74,5))
names(original.Polymod.Fractions) = Original.Polymod.AgeGroups

# Simplifying the contact matrices: 
# 16 age-groups --> 6 age groups: 
# (0-4, 5-17, 18 - 49, 50 - 64, 65 - 74, 75+)


US_Polymod = list()

for(i in ContactTypes)
{
  US_Polymod[[i]] = makeContactMatrix(ages = c(4,17,49,64,74),
                                      originalContactMatrix = US_Polymod_Raw[[i]],
                                      originalContactMatrixAges = original.Polymod.Ages,
                                      originalPopulationFractions = original.Polymod.Fractions)
}


BaseContactMatrix = US_Polymod$`All Locations`
```



**Create support functions**

*Gradual_ContactMatrix()*

  * Inputs:
  
    * StartMatrix: contact matrix on the first day of the transition period
  
    * EndMatrix: contact matrix on the last day of the transition period
  
    * TransitionDays: days of the transition period. an increasing sequence of positive, consecutive integers
  
  * Output:a list of contact matrices, the i-th entry of which corresponds to the i-th entry in transition days 
  
```{r}
Gradual_ContactMatrix = function(StartMatrix, 
                                 EndMatrix,
                                 TransitionDays)
{
  Matrices=list(StartMatrix)
  TransitionPeriod=max(TransitionDays)-min(TransitionDays)
  DifferenceMatrix = (EndMatrix-StartMatrix)/TransitionPeriod
  for(i in 1:TransitionPeriod)
  {Matrices[[i+1]] = StartMatrix + i*DifferenceMatrix}
  return(Matrices)
}

## the population groups

strata.names = 
  c("Age00to4",
    "Age5to17",
    "Age18to49.LowRisk.NonEssential", 
    "Age18to49.HighRisk.NonEssential", 
    "Age18to49.LowRisk.Essential", 
    "Age18to49.HighRisk.Essential",
    "Age50to64.LowRisk.NonEssential", 
    "Age50to64.HighRisk.NonEssential", 
    "Age50to64.LowRisk.Essential",
    "Age50to64.HighRisk.Essential",
    "Age65to74.LowRisk",
    "Age65to74.HighRisk",
    "Age75plus.LowRisk",
    "Age75plus.HighRisk"
    )

child.strata = which(strata.names %in% c("Age00to4","Age5to17"))

elderly.strata = 
  which(strata.names %in% c("Age65to74.LowRisk", "Age65to74.HighRisk",
                             "Age75plus.LowRisk", "Age75plus.HighRisk"))

Strata.18to64 =   
  which(strata.names %in% 
    c("Age18to49.LowRisk.NonEssential", "Age18to49.HighRisk.NonEssential", 
      "Age18to49.LowRisk.Essential", "Age18to49.HighRisk.Essential",
      "Age50to64.LowRisk.NonEssential", "Age50to64.HighRisk.NonEssential", 
    "Age50to64.LowRisk.Essential", "Age50to64.HighRisk.Essential"))

Essential.Strata =   
  which(strata.names %in% 
    c("Age18to49.LowRisk.Essential", "Age18to49.HighRisk.Essential",
      "Age50to64.LowRisk.Essential", "Age50to64.HighRisk.Essential"))

Nonessential.Strata =   
  which(strata.names %in% 
    c("Age18to49.LowRisk.NonEssential", "Age18to49.HighRisk.NonEssential", 
      "Age50to64.LowRisk.NonEssential", "Age50to64.HighRisk.NonEssential"))


Gen.Pop.Age.Distr = 
  getPopulationFractions(c(4,17,49,64,74))
names(Gen.Pop.Age.Distr) = rownames(US_Polymod$`All Locations`)

 Phase1B.strata = 
  unique(
     c(grep("HighRisk",x=strata.names),      
       grep("LowRisk.Essential",strata.names),
       grep("Age65to74",strata.names),
       grep("Age75plus",strata.names)))

```



*expand.contact.matrix()*

 * Inputs:
  
    * *contact.matrix*: a 6x6 contact matrix (each row/column representing the following age-groups, in order (left to right, top to bottom): 0-4, 5-17, 18-49, 50-64, 65-74, 75+) for one of the 4 POLYMOD setting (home, school, work, or other). 
    
      * Each entry represents mean daily number of contacts that a member of the column age group has with members of the row age group.
  
    * *frac.adults.essential*: the fraction of adults in the 18-49 and 50-64 age groups who are essential workers.
  
    * *frac.adults.high.risk*: the fraction of adults in the 18-49, 50-64, 65-74 and 75+ age groups who have a high risk medical condition
  
    * *is.Work.Matrix*: whether or not the matrix represents workplace contacts (TRUE or FALSE). If true, essential and non-essential workers will not mix with each other.
  
    * *baseline.contact.matrix*: the corresponding contact matrix for the setting in the absence of interventions or behavior changes (that is, pre-pandemic contacts rates).
  
    * *essential.distancing*: The fraction of workplace contacts made by essential workers that are eliminated when social distancing measures are in effect.

      * Defaults to 0.35
  
* Output: an expanded 14x14 contact matrix, stratified by essential worker and underlying condition status. See *strata.names* in the code chunk above for definitions of each row/column.
  
  
```{r}

expand.contact.matrix = 
  function(contact.matrix, frac.adults.essential, 
           frac.adults.high.risk, 
           is.Work.Matrix, baseline.contact.matrix,
           essential.distancing = 0.35)
  {
    # Ensuring that dimensions match between the contact.matrix and baseline.contact.matrix
    if(nrow(contact.matrix)!=nrow(baseline.contact.matrix) | 
       ncol(contact.matrix)!=ncol(baseline.contact.matrix))
    {stop("contact.matrix and baseline.contact.matrix dimensions don't match")}
    
    # Ensuring that frac.adults.essential and frac.adults.high.risk 
    # are vectors of length 2 and 4 respectively 
    
    if(length(frac.adults.essential)!= 2){stop("length(frac.adults.essential) must be 2")}

    if(length(frac.adults.high.risk)!= 4){stop("length(frac.adults.high.risk) must be 4")}
    
    
    frac.adults.nonEssential = 
      1- (frac.adults.essential)
    
    frac.adults.low.risk = 1 - frac.adults.high.risk
    
    # naming vectors 
    
    names(frac.adults.nonEssential) = c("Age18to49", "Age50to64")
    names(frac.adults.essential) = c("Age18to49", "Age50to64")
    names(frac.adults.high.risk) = 
      c("Age18to49", "Age50to64", "Age65to74", "Age75plus")
    names(frac.adults.low.risk) = names(frac.adults.high.risk)
    
    # creating the eventual output, a new contact matrix
    
    new.matrix = matrix(nrow = 14,ncol =14,
                        dimnames = 
                          list( strata.names, strata.names))
    
    # Contacts between children are identical, since these age groups are not subdivided by essential worker or comorbidity status
    new.matrix[c(child.strata),c(child.strata)] =
      contact.matrix[c(child.strata),c(child.strata)]
    
    # Duplicating contacts from elderly adults to children,
    # as these are not affected by the comorbidity status of the former
    new.matrix[child.strata, elderly.strata] =
    contact.matrix[c("Age00to4", "Age5to17"),
                   c(rep("Age65to74",2),rep("Age75plus",2))]
    
    # Distributing contacts from children and elderly adults to elderly adults,
    # based on the prevalence of comorbidities in the latter
     new.matrix[elderly.strata, c(child.strata, elderly.strata)] = 
      contact.matrix[c(rep("Age65to74",2),rep("Age75plus",2)),
                c("Age00to4", "Age5to17","Age65to74","Age65to74","Age75plus","Age75plus")]*
   c(frac.adults.low.risk[3],frac.adults.high.risk[3],
     frac.adults.low.risk[4],frac.adults.high.risk[4])
     
    
    # determining if any entries of contact.matrix are less than the 
    # associated entry of baseline.contact.matrix, which would indicate that community mitigation
    # is in effect 
     
     is.baseline = 
       ifelse(any(contact.matrix-baseline.contact.matrix  < 0, na.rm=T),
              FALSE, TRUE)
     
     # looping through each row i (contact "recipient") and column j (contact "giver")
     # of the expanded contact matrix to calculate each contact rate between nonelderly adults 
     
     for(i in strata.names[Strata.18to64])
     {
       for(j in strata.names[Strata.18to64])
       {
         # if this matrix does not represent workplace interactions while community mitigation measures are in place,
         # contacts are simply distributed according to the prevalence of 
         # comorbidities and essential workers in the recipient age group
         if(!is.Work.Matrix )
         {
           
           if(grepl("NonEssential",i))
           {essential.multiplier = frac.adults.nonEssential[substr(i,1,9)]}
           if(grepl("Risk.Essential",i))
           {essential.multiplier = frac.adults.essential[substr(i,1,9)]}
           
           risk.multiplier =
             ifelse(grepl("LowRisk",i),
                    frac.adults.low.risk[substr(i,1,9)],
                    frac.adults.high.risk[substr(i,1,9)])
           
       new.matrix[i,j] =
         essential.multiplier*
         risk.multiplier*
         contact.matrix[substr(i,1,9),substr(j,1,9)]
         }
         
         if(is.Work.Matrix & is.baseline)
         {
           
          
           
           essential.multiplier = 
             ifelse(grepl("NonEssential",i)==grepl("NonEssential",j),1,0)
           
           risk.multiplier =
             ifelse(grepl("LowRisk",i),
                    frac.adults.low.risk[substr(i,1,9)],
                    frac.adults.high.risk[substr(i,1,9)])
           
       new.matrix[i,j] =
         essential.multiplier*
         risk.multiplier*
         contact.matrix[substr(i,1,9),substr(j,1,9)]
         }
         
         # if this matrix does represent workplace interactions while community mitigation measures are in place,
         # then individuals only interact with others of the same worker-class (essential or not). 
         # The age-specific contact rates of each worker-class are scaled to ensure consistency with both the original contact matrix 
         # entry and, if possible, essential.distancing. In cases where a sufficiently large overall contact reduction can not 
         # otherwise be achieved, essential.distancing is increased and a warning is given.
         # Within a given worker-class, contacts are distributed according to the prevalence of comorbities in the recipient age group,
         # which we assume is independent of essential worker status.
         
         if(is.Work.Matrix & !is.baseline)
         {
           mean.contacts = contact.matrix[substr(i,1,9),substr(j,1,9)]
           mean.contacts.baseline =
             baseline.contact.matrix[substr(i,1,9),substr(j,1,9)]
           
           frac.essential.col = frac.adults.essential[substr(j,1,9)]
           
         frac.essential.row = frac.adults.essential[substr(i,1,9)]
         
         
           

           frac.contacts.eliminated.nonessential=
             1-((mean.contacts - (frac.essential.col*(1-essential.distancing)*mean.contacts.baseline))/
                  (mean.contacts.baseline*(1-frac.essential.col)))
           
           
           if(frac.contacts.eliminated.nonessential>1){
             frac.contacts.eliminated.nonessential=1
             
             frac.contacts.eliminated.essential = 
               1 - mean.contacts/(frac.essential.col*mean.contacts.baseline) 
             
             warning(
               paste0("nonessential workplace contacts reduced 100%, essential workplace contacts reduced ", 
                     round(100*frac.contacts.eliminated.essential),"%"))
           }
           else
           {frac.contacts.eliminated.essential = essential.distancing }
           
           
          contacts.nonEssential =
            (1-frac.contacts.eliminated.nonessential)*mean.contacts.baseline
           contacts.Essential    =
             (1-frac.contacts.eliminated.essential)*mean.contacts.baseline
           
           weighted.mean.contacts = 
             (1-frac.essential.col)*contacts.nonEssential +
             frac.essential.col*contacts.Essential
           
           if(abs( (weighted.mean.contacts-mean.contacts)/mean.contacts)  < 0.01 )
           {
             contacts.nonEssential = contacts.nonEssential*(mean.contacts/weighted.mean.contacts)
             contacts.Essential = contacts.Essential*(mean.contacts/weighted.mean.contacts)
           }
           else
           {
           stop(paste0("weighted.mean.contacts and mean.contacts differ by more than 1% (",
                         100*round((weighted.mean.contacts-mean.contacts)/mean.contacts,2),"%)"))
           }
           
           if(round(mean.contacts,10) !=   
              round((1-frac.essential.col)*contacts.nonEssential     +
                    frac.essential.col*contacts.Essential,10))
           {stop(paste("the weighted average of contacts.nonEssential and contacts.Essential do not equal mean.contacts:",
                       "i =",i,", j =",j,": mean.contacts =", mean.contacts,", weighted avg =", (1-frac.essential.col)*contacts.nonEssential     +
                         frac.essential.col*contacts.Essential))
             }
          
        
            essential.multiplier = 
             ifelse(grepl("NonEssential",i)==grepl("NonEssential",j),1,0)
          
           
           risk.multiplier = 
             ifelse(grepl("LowRisk",i),
                    frac.adults.low.risk[substr(i,1,9)],
                    frac.adults.high.risk[substr(i,1,9)])
           
           
           new.matrix[i,j] = 
             ifelse(grepl("NonEssential",j),
                      contacts.nonEssential,
                      contacts.Essential)*
             risk.multiplier*
             essential.multiplier
           
        }
       }
     }
   
     
    # Calculating contact rates from non-elderly adults to children and the elderly.
    # Assume that all workplace contacts with children are made by non-essential workers.
   for(j in strata.names[Strata.18to64])
     {

  essential.multiplier =
    ifelse(grepl("NonEssential",j),
           1/(frac.adults.nonEssential[substr(j,1,9)]),
           0)


      new.matrix[1:2,j] =
        contact.matrix[1:2,substr(j,1,9)]*
        ifelse(is.Work.Matrix, essential.multiplier, 1)

      new.matrix[c("Age65to74.LowRisk","Age65to74.HighRisk",
                   "Age75plus.LowRisk","Age75plus.HighRisk"),j] =
        contact.matrix[c(5,5,6,6),substr(j,1,9)]*
        c(frac.adults.low.risk[3],
          frac.adults.high.risk[3],
          frac.adults.low.risk[4],
          frac.adults.high.risk[4])*
        ifelse(is.Work.Matrix, 
               essential.multiplier, 
               1)


    }
     
     
    # Calculating contact rates from children and the elderly to non-elderly adults.
    # Assume that all workplace contacts made by children are with non-essential workers.
     for(i in strata.names[Strata.18to64])
     {
       risk.multiplier =
        ifelse(grepl("LowRisk",i),
               frac.adults.low.risk[substr(i,1,9)],
               frac.adults.high.risk[substr(i,1,9)])

      if(!is.Work.Matrix)
      {
        if(grepl("NonEssential",i))
          {essential.multiplier = frac.adults.nonEssential[substr(i,1,9)]}
          if(grepl("Risk.Essential",i))
          {essential.multiplier = frac.adults.essential[substr(i,1,9)]}
         
      }

    if(is.Work.Matrix)
      {essential.multiplier =ifelse(grepl("NonEssential",i),1,0)}

    new.matrix[i,child.strata] =
      risk.multiplier*
      essential.multiplier*
      contact.matrix[substr(i,1,9),1:2]

    new.matrix[i,c("Age65to74.LowRisk","Age65to74.HighRisk",
                   "Age75plus.LowRisk","Age75plus.HighRisk")] =
      risk.multiplier*
      essential.multiplier*
      contact.matrix[substr(i,1,9),c(5,5,6,6)]

      }
     
  

    new.matrix
  }
  
```

**Defining Full Contact Matrices**

```{r}

Frac.Schools.Open = .05 # The fraction of schools that remain open under the "High Mitigation" set of policies

Baseline = US_Polymod$`All Locations`
Essential=80E6*1 # the assumed number of essential workers, among ages 18 to 64, in the US population
frac.adults.essential = rep(Essential /(330E6*sum(Gen.Pop.Age.Distr[3:4])),2) # the fraction of adults who are essential workers in the 18-49 and 50-64 age groups
names(frac.adults.essential) = c("Age18to49", "Age50to64")

# Defining contact matrices at baseline and with full, high (with and without some schools open), moderate and low levels of community mitigation in place
Baseline_Matrices =
  list(
    Home=US_Polymod$Home,
    School=US_Polymod$School,
    Work=US_Polymod$Work,
    Other=US_Polymod$OtherLocations
  )

Full_Mitigation_Matrices = 
  list(
    Home = US_Polymod$Home,
    School = 0.05*US_Polymod$School,
    Work = US_Polymod$Work*
      matrix(nrow=6,
             data=c(rep(c(rep(0.2,4),0.1, 0.1),4),
                    rep(0.1,12)),byrow=T),
    Other = US_Polymod$OtherLocations*
      matrix(nrow=6,
             data=c(rep(c(rep(0.2,4),0.1 , 0.1),4),
                    rep(0.1,12)),byrow=T)
  )

High_Mitigation_Matrices = 
  list(
    Home = US_Polymod$Home,
    School =  Frac.Schools.Open*US_Polymod$School*
      matrix(nrow=6,
             data=c(rep(c(rep(0.6,4),0.25,0.25),4),
                    rep(0.25,12)),byrow=T)  +
      (1-Frac.Schools.Open)*.05*US_Polymod$School,
    Work = US_Polymod$Work*
      matrix(nrow=6,
             data=c(rep(c(rep(0.4,4),0.15,0.15),4),
                    rep(0.15,12)),byrow=T),
    Other = US_Polymod$OtherLocations*
      matrix(nrow=6,
             data=c(rep(c(rep(0.5,4),0.3,0.3),4),
                    rep(0.3,12)),byrow=T)
  
  )

High_Mitigation_SchoolClosed_Matrices = 
  list(
    Home = US_Polymod$Home,
    School =  Frac.Schools.Open*US_Polymod$School,
    Work = US_Polymod$Work*
      matrix(nrow=6,
             data=c(rep(c(rep(0.4,4),0.15,0.15),4),
                    rep(0.15,12)),byrow=T),
    Other = US_Polymod$OtherLocations*
      matrix(nrow=6,
             data=c(rep(c(rep(0.5,4),0.3,0.3),4),
                    rep(0.3,12)),byrow=T)

  )

Moderate_Mitigation_Matrices = 
  list(
    Home = US_Polymod$Home,
    School = US_Polymod$School*matrix(nrow=6,
                                      data=c(rep(c(rep(0.7,4),0.35,0.35),4),
                                             rep(0.35,12)),byrow=T),
    Work = US_Polymod$Work*
      matrix(nrow=6,
             data=c(rep(c(rep(0.5,4),0.45,0.45),4),
                    rep(0.45,12)),byrow=T),
    Other = US_Polymod$OtherLocations*
      matrix(nrow=6,
             data=c(rep(c(rep(0.7,4),0.45,0.45),4),
                    rep(0.45,12)),byrow=T)
  )


Low_Mitigation_Matrices = 
  list(
    Home = US_Polymod$Home,
    School = 0.9*US_Polymod$School,
    Work = US_Polymod$Work*.7,
    Other = US_Polymod$OtherLocations*.8
  )
```

**Natural History, Severity, and Seeding Parameters**

```{r}

propTransBeforeSymptoms = 0.35 # the proportion of transmission assumed to take place before symptom onset

basePars = list(population=100E3,
                populationFractions=
                  getPopulationFractions(ages=c(4,17,49,64,74)),
                ContactMatrices=list(
                  matrix(0,nrow=14,ncol=14,dimnames=list(strata.names,strata.names))),
                ContactMatrixStartDay =  c(0),         
                latentPeriod = 5.1, # assumed mean duration of the period from exposure to symptom onset
                priorImmunity = 0, # assume no pre-existing immunity in the population before infections are seeded
                seedInfections = c(0,0,1,0,0,0), # infections seeded in the 18-49 age group
                simulationLength = 365*2) # models run for 2 years, starting on 1/1/2020


for(i in names(Baseline_Matrices))
{
  basePars$ContactMatrices[[1]] = 
    basePars$ContactMatrices[[1]] +
    expand.contact.matrix(contact.matrix = Baseline_Matrices[[i]],
                          baseline.contact.matrix = Baseline_Matrices[[i]],
                          is.Work.Matrix = ifelse(i=="Work",TRUE,FALSE),
                          frac.adults.essential = frac.adults.essential,
                          frac.adults.high.risk = c(0.316 , 0.481, 0.555,0.547)
                          )
}



central_scenario <- c(basePars,list(R0 = 2.5, # assume that, in a completely susceptible population with no social distancing or community mitigation measures, each case infects 2.5 others on average
                                    fractionSymptomatic = 0.65, # assume that 65% of infections will eventually develop symptoms
                                    relativeInfectivityAsymptomatic = 1, # assume no difference in transmissibility between cases that do and do not eventually develop symptoms 
                                    infectiousPeriod = 4, # assume that cases remain asymptomatic for 4 days following symptom onset ()
                                    R0_amp=0, # assume no seasonal variation in transmissibility over the course of the year
                                    dayOfR0=75, # if transmissibility did vary seasonally, in a sinusoidal pattern, R0 would have the above value (currently 2.5) on the 75th day of 2020 (March 15th)
                                    offset=-3.8*7, # when R0_amp is > 0, peak transmissibility occurs 3.8 weeks before 1/1/2020. at this time, the value of R0 would be equal to the above value (2.5) plus R0_amp
                                    hospDuration = c(3, 3, 3 , 4, 6, 6), # assumed mean duration of hospitalization, in days, for each age group. Doesn't affect the results of this particular analysis, but code will not run if not provided.
                                    caseHospitalizationRatio =
                               c(0.006,0.006,0.0328,0.0672,0.0989,0.155573)/0.65, # the age-specific probability of being hospitalized if infected
                                    DelayOnsetToHosp = 6)) # mean days from symptom onset to hospitalization

central_scenario = c(central_scenario, 
                     list(fractionLatentThatIsInfectious = 
                            central_scenario$infectiousPeriod *
                            propTransBeforeSymptoms/
                            ((1-propTransBeforeSymptoms)*central_scenario$latentPeriod)
                     ))

scenario_central_outcomes <- list(
  caseFatalityRatio = c(0.00004,0.00004,0.00089,0.00846,0.0445,0.07)/central_scenario$fractionSymptomatic,
  caseHospitalizationRatio = c(0.006,0.006,0.0328,0.0672,0.0989,0.155573)/central_scenario$fractionSymptomatic,
  meanHospDuration = c(3.1, 3.1, 3.1 ,7.8, 6.5,6.5),
  hospIcuRatio = c(10,10,10,20,30,35)/100)

RR.Severe = 3 # the base case relative risk of experiencing hospitalization/death, within an age group, between those with and without a high risk medical condition

frac.adults.high.risk = 
  c(0.316, 0.481, 0.555,0.547)

frac.adults.nonEssential = 1 - frac.adults.essential

caseFatalityRatio=c()
caseFatalityRatio.low.RR=c()
caseFatalityRatio.high.RR=c()
caseHospitalizationRatio=c()
caseHospitalizationRatio.low.RR=c()
caseHospitalizationRatio.high.RR=c()
meanHospDuration=c()
hospIcuRatio=c()
populationFractions=c()

caseFatalityRatio[c(1,2)]=scenario_central_outcomes$caseFatalityRatio[c(1,2)]
caseFatalityRatio.low.RR[c(1,2)]=caseFatalityRatio[c(1,2)]
caseFatalityRatio.high.RR[c(1,2)]=caseFatalityRatio[c(1,2)]

caseHospitalizationRatio[c(1,2)]=scenario_central_outcomes$caseHospitalizationRatio[c(1,2)]
caseHospitalizationRatio.low.RR[c(1,2)]=caseHospitalizationRatio[c(1,2)]
caseHospitalizationRatio.high.RR[c(1,2)]=caseHospitalizationRatio[c(1,2)]


meanHospDuration[c(1,2)]=scenario_central_outcomes$meanHospDuration[c(1,2)]
hospIcuRatio[c(1,2)]=scenario_central_outcomes$hospIcuRatio[c(1,2)]
populationFractions[c(1,2)]=central_scenario$populationFractions[c(1,2)]

Remaining.Years.Life = c(77, 68, 47, 26, 16, 8) # based on 2019 US census age distribution and 2017 CDC life table

Remaining.Years.Life.Expanded = c()
Remaining.Years.Life.Expanded[1:2] = Remaining.Years.Life[1:2]
Remaining.Years.Life.Expanded[grep("18to49",strata.names)] = Remaining.Years.Life[3]
Remaining.Years.Life.Expanded[grep("50to64",strata.names)] = Remaining.Years.Life[4]
Remaining.Years.Life.Expanded[grep("65to74",strata.names)] = Remaining.Years.Life[5]
Remaining.Years.Life.Expanded[grep("75plus",strata.names)] = Remaining.Years.Life[6]

for(i in strata.names[3:14])
{
  index = which(grepl(i,strata.names))
  
  if(grepl("Age18to49",i))
  {
    frac.high.risk = frac.adults.high.risk[1]
    fraction.essential = frac.adults.essential[1]
    mean.CFR = scenario_central_outcomes$caseFatalityRatio[3]
    mean.CHR = scenario_central_outcomes$caseHospitalizationRatio[3]
    overall.pop.frac = central_scenario$populationFractions[3]
  }
  
  if(grepl("Age50to64",i))
  {
    frac.high.risk = frac.adults.high.risk[2]
    fraction.essential = frac.adults.essential[2]
    mean.CFR = scenario_central_outcomes$caseFatalityRatio[4]
    mean.CHR = scenario_central_outcomes$caseHospitalizationRatio[4]
    overall.pop.frac = central_scenario$populationFractions[4]
  }
  
  if(grepl("Age65to74",i))
  {
    frac.high.risk = frac.adults.high.risk[3]
    mean.CFR = scenario_central_outcomes$caseFatalityRatio[5]
    mean.CHR = scenario_central_outcomes$caseHospitalizationRatio[5]
    overall.pop.frac = central_scenario$populationFractions[5]
  }
  
  if(grepl("Age75plus",i))
  {
    frac.high.risk = frac.adults.high.risk[4]
    mean.CFR = scenario_central_outcomes$caseFatalityRatio[6]
    mean.CHR = scenario_central_outcomes$caseHospitalizationRatio[6]
    overall.pop.frac = central_scenario$populationFractions[6]
  }
  

  CFR.low.risk = mean.CFR/ ((1-frac.high.risk) + frac.high.risk*c(RR.Severe,2,4))
  CHR.low.risk = mean.CHR/ ((1-frac.high.risk) + frac.high.risk*c(RR.Severe,2,4))
  CFR.high.risk = CFR.low.risk*c(RR.Severe,2,4)
  CHR.high.risk = CHR.low.risk*c(RR.Severe,2,4)

  CFR.mid.RR = ifelse(grepl("HighRisk",i),CFR.high.risk[1],CFR.low.risk[1])
  CFR.low.RR = ifelse(grepl("HighRisk",i),CFR.high.risk[2],CFR.low.risk[2])
  CFR.high.RR = ifelse(grepl("HighRisk",i),CFR.high.risk[3],CFR.low.risk[3])
  
  CHR.mid.RR = ifelse(grepl("HighRisk",i),CHR.high.risk[1],CHR.low.risk[1])
  CHR.low.RR = ifelse(grepl("HighRisk",i),CHR.high.risk[2],CHR.low.risk[2])
  CHR.high.RR = ifelse(grepl("HighRisk",i),CHR.high.risk[3],CHR.low.risk[3])
  
  caseFatalityRatio[index] = CFR.mid.RR
  caseFatalityRatio.low.RR[index] = CFR.low.RR
  caseFatalityRatio.high.RR[index] = CFR.high.RR
  
  caseHospitalizationRatio[index] = CHR.mid.RR
  caseHospitalizationRatio.low.RR[index] = CHR.low.RR
  caseHospitalizationRatio.high.RR[index] = CHR.high.RR
  
  meanHospDuration[index] = ifelse(grepl("Age18to49",i), 
                                   scenario_central_outcomes$meanHospDuration[3],
                                   scenario_central_outcomes$meanHospDuration[4])

    hospIcuRatio[index] = ifelse(grepl("Age18to49",i), 
                               scenario_central_outcomes$hospIcuRatio[3],
                               scenario_central_outcomes$hospIcuRatio[4])
  
  populationFractions[index] = 
    overall.pop.frac*
    ifelse(grepl("HighRisk",i),
           frac.high.risk,
           1-frac.high.risk)*
    ifelse(grepl("Age65to74",i)|grepl("Age75plus",i),
           1,
           ifelse(grepl("NonEssential",i),
                  1-fraction.essential ,
                         fraction.essential))
}


scenario_central_outcomes$caseFatalityRatio=caseFatalityRatio
scenario_central_outcomes$caseHospitalizationRatio=caseHospitalizationRatio
central_scenario$caseHospitalizationRatio=caseHospitalizationRatio
scenario_central_outcomes$meanHospDuration=meanHospDuration
scenario_central_outcomes$hospIcuRatio=hospIcuRatio
central_scenario$hospDuration = meanHospDuration

basePars$seedInfections = c(rep(0,3),1,rep(0,10)) 
central_scenario$seedInfections = c(rep(0,3),1,rep(0,10)) 

basePars$populationFractions = populationFractions
central_scenario$populationFractions = populationFractions


CFR.LIST = list("Mid.RR" = caseFatalityRatio,
                "Low.RR" = caseFatalityRatio.low.RR,
                "High.RR"= caseFatalityRatio.high.RR)

CHR.LIST = list("Mid.RR" = caseHospitalizationRatio,
                "Low.RR" = caseHospitalizationRatio.low.RR,
                "High.RR"= caseHospitalizationRatio.high.RR)


# Calculates the day on which a single infection must be introduced into the population (size 100k here, based on Pars$population) to achieve an incidence of approximately CumIncAtTrigger (a proportion) on day TriggerDay of 2020 (set to 75 here, or 3/15/2020). By default, assume no seasonal variation in transmission (Seasonal = F). Otherwise, seasonality parameters should be included in the list provided to pars (see SEAIRTV.R for details). 

FindSeedDay = function(pars, CumIncAtTrigger,TriggerDay=75, Seasonal=F)
{
  
  Parameters = pars
  Parameters$simulationLength = TriggerDay - 1
  
  Parameters$Seasonality = Seasonal
  seedDay = TriggerDay - 2
  CumInc = 0
  
  while(CumInc < CumIncAtTrigger)
  {
    seedDay = seedDay -1
    
    UnmitigatedModel = do.call(SEAIRTVModel, c(Parameters,
                                               useCommunityMitigation =F,
                                               list(seedStartDay = seedDay)))
    
    UnmitigatedInfections = getInfectionTimeSeries(UnmitigatedModel,  byGroup=F,incidence=T)
    
    
    UnmitigatedInfections[UnmitigatedModel$parameters$seedStartDay+1]=0
    
    CumInc = sum(UnmitigatedInfections[1:TriggerDay])/UnmitigatedModel$parameters$population
  }
  
  seedDay
}

DataFrame = tibble(CumIncAtTrigger = 
                     c(.5, 5, 0.04)/100 ,
                   Setting = c("National", 
                               "Jurisdiction A", 
                               "Jurisdiction B"))

DataFrame = DataFrame %>% mutate(SeedDay = map_dbl(
  .x = DataFrame$CumIncAtTrigger,
  .f=function(.x)
  {Pars = central_scenario
  Pars$R0_amp = 0
  FindSeedDay(pars=Pars, CumIncAtTrigger = .x)}))
```

# Running the Model
 
**Defining the Timing and Strength of Community Mitigation Phases**

```{r}

Baseline.R0 =
  list("National" = 2.5,
       "Jurisdiction A" = 2.5,
       "Jurisdiction B" = 2.5
  )


# StayHome_TransitionDays: the period, starting in March 2020, over which contact rates gradually decrease as community mitigation measures are imposed

StayHome_TransitionDays =
  list("National" = seq(as.numeric(as.Date("2020-03-10")-
                                     as.Date("2020-01-01")),
                        as.numeric(as.Date("2020-03-30")-
                                 as.Date("2020-01-01")),1),
       
     "Jurisdiction A" = seq(as.numeric(as.Date("2020-03-15")-
                                     as.Date("2020-01-01")),
                        as.numeric(as.Date("2020-03-18")-
                               as.Date("2020-01-01")),1),
       
    "Jurisdiction B" = seq(as.numeric(as.Date("2020-03-15")-
                                 as.Date("2020-01-01")),
                    as.numeric(as.Date("2020-04-05")-
                                 as.Date("2020-01-01")),1))

# ReOpen_TransitionDays: the period, starting in the late spring / early summer, during which contact rates gradually increase as community mitigation measures are lifted

ReOpen_TransitionDays =
  list("National" = seq(as.numeric(as.Date("2020-05-14")-
                                     as.Date("2020-01-01")+1),
                        as.numeric(as.Date("2020-06-09")-
                             as.Date("2020-01-01")+1),1),
       
       
       "Jurisdiction A" =
         seq(as.numeric(as.Date("2020-03-20")-
                         as.Date("2020-01-01")+1),
                        as.numeric(as.Date("2020-05-01")-
                             as.Date("2020-01-01")+1),1),
       
       "Jurisdiction B" = 
         seq(as.numeric(as.Date("2020-04-07")-
                       as.Date("2020-01-01")+1),
                    as.numeric(as.Date("2020-06-04")-
                                 as.Date("2020-01-01")+1),1))

# ReOpening.Intensity: proportional to the magnitude of the increase in contact rates when community mitigation measures are lifted in the late spring / early summer

ReOpening.Intensity = 
  c("National"=1, 
    "Jurisdiction A"=0, 
    "Jurisdiction B" = 1)


# Pause.Day: the day in the summer that contact rates start to decrease as community mitigation measures are reimposed and activity declines

Pause.Day = 
  list("National" = 
         as.numeric(as.Date("2020-07-10")-
                      as.Date("2020-01-01")+1),
       "Jurisdiction A" = 
         as.numeric(as.Date("2020-07-01")-
                      as.Date("2020-01-01")+1),
       "Jurisdiction B" = 
         as.numeric(as.Date("2020-06-13")-
                      as.Date("2020-01-01")+1))

# Post.Pause.End.Day: the last day of the period starting on Pause.Day during which contact rates decrease as community mitigation measures are re-imposed and activity declines

Post.Pause.End.Day = 
  list("National" = Pause.Day[["National"]] + 15,
       "Jurisdiction A" = Pause.Day[["Jurisdiction A"]] + 15, 
       "Jurisdiction B" =     Pause.Day[["Jurisdiction B"]] + 15)

# Post.Pause.Reversion.Factor_Third.Wave: proportional to the magnitude of the decrease in contact rates when community mitigation measures are re-imposed and activity declines between Pause.Day and Post.Pause.End.Day

Post.Pause.Reversion.Factor = 
  list("National" = 0.6,
       "Jurisdiction A" = 0, 
       "Jurisdiction B" =   .8)

# Post.Pause.Reversion.Factor_Third.Wave: proportional to the magnitude of the decrease in contact rates when community mitigation measures are re-imposed and activity declines starting on Pause.Day.Third.Wave and ending (Post.Pause.End.Day - Pause.Day) days later

Post.Pause.Reversion.Factor_Third.Wave = 
  list("National" = 0.5,
       "Jurisdiction A" = 0.8, 
       "Jurisdiction B" =   .7)

# Third.Wave.Reopening.End: the final day of the period in the fall during which contact rates increase as community mitigation measures are lifted and activity increases. The length of this period is the same as ReOpen_TransitionDays

Third.Wave.Reopening.End = 
  list(
    "Dec" = 
      c("National" =  as.numeric(as.Date("2020-10-25")-as.Date("2020-01-01")+1),
        "Jurisdiction A" = as.numeric(as.Date("2020-09-25")-as.Date("2020-01-01")+1),
        "Jurisdiction B"     = as.numeric(as.Date("2020-11-15")-as.Date("2020-01-01")+1)),
    
    "Feb" = 
      c("National" =  as.numeric(as.Date("2020-12-25")-as.Date("2020-01-01")+1),
        "Jurisdiction A" = as.numeric(as.Date("2020-11-15")-as.Date("2020-01-01")+1),
        "Jurisdiction B"     = as.numeric(as.Date("2021-01-15")-as.Date("2020-01-01")+1)),
    
    "Apr" =
      c("National" =  as.numeric(as.Date("2021-01-20")-as.Date("2020-01-01")+1),
        "Jurisdiction A" = as.numeric(as.Date("2020-12-25")-as.Date("2020-01-01")+1),
        "Jurisdiction B"     = as.numeric(as.Date("2021-03-05")-as.Date("2020-01-01")+1)),
    
    "Jun" =
      c("National" =  as.numeric(as.Date("2021-03-01")-as.Date("2020-01-01")+1),
        "Jurisdiction A" = as.numeric(as.Date("2021-02-10")-as.Date("2020-01-01")+1),
        "Jurisdiction B"     = as.numeric(as.Date("2021-04-25")-as.Date("2020-01-01")+1))
  )

# the day in the fall/winter that contact rates start to decrease as community mitigation measures are reimposed and activity declines
Pause.Day.Third.Wave = 
  list(
    "National" = c("Dec" = as.numeric( 
      Pause.Day[["National"]] -
        max(ReOpen_TransitionDays[["National"]]) +
        Third.Wave.Reopening.End[["Dec"]]["National"]),
      
      "Feb" = as.numeric( 
        Pause.Day[["National"]] -
          max(ReOpen_TransitionDays[["National"]]) +
          Third.Wave.Reopening.End[["Feb"]]["National"]),
      
      
      "Apr" = as.numeric(
        Pause.Day[["National"]] -
          max(ReOpen_TransitionDays[["National"]]) +
          Third.Wave.Reopening.End[["Apr"]]["National"]),
      
      "Jun" = as.numeric(
        Pause.Day[["National"]] -
          max(ReOpen_TransitionDays[["National"]]) +
          Third.Wave.Reopening.End[["Jun"]]["National"])
    ),
    
    "Jurisdiction A" = c("Dec" = as.numeric( 
      Pause.Day[["Jurisdiction A"]] -
        max(ReOpen_TransitionDays[["Jurisdiction A"]]) +
        Third.Wave.Reopening.End[["Dec"]]["Jurisdiction A"]),
      
      "Feb" = as.numeric( 
        Pause.Day[["Jurisdiction A"]] -
          max(ReOpen_TransitionDays[["Jurisdiction A"]]) +
          Third.Wave.Reopening.End[["Feb"]]["Jurisdiction A"])+10,
      
      "Apr" = as.numeric(
        Pause.Day[["Jurisdiction A"]] -
          max(ReOpen_TransitionDays[["Jurisdiction A"]]) +
          Third.Wave.Reopening.End[["Apr"]]["Jurisdiction A"]+25),
      
      "Jun" = as.numeric(
        Pause.Day[["Jurisdiction A"]] -
          max(ReOpen_TransitionDays[["Jurisdiction A"]]) +
          Third.Wave.Reopening.End[["Jun"]]["Jurisdiction A"]+40)
    ),
    
    
    "Jurisdiction B" = c("Dec" = as.numeric( 
      Pause.Day[["Jurisdiction B"]] -
        max(ReOpen_TransitionDays[["Jurisdiction B"]]) +
        Third.Wave.Reopening.End[["Dec"]]["Jurisdiction B"]),
      
      "Feb" = as.numeric( 
        Pause.Day[["Jurisdiction B"]] -
          max(ReOpen_TransitionDays[["Jurisdiction B"]]) +
          Third.Wave.Reopening.End[["Feb"]]["Jurisdiction B"]),
      
      "Apr" = as.numeric(
        Pause.Day[["Jurisdiction B"]] -
          max(ReOpen_TransitionDays[["Jurisdiction B"]]) +
          Third.Wave.Reopening.End[["Apr"]]["Jurisdiction B"]),
      
      "Jun" = as.numeric(
        Pause.Day[["Jurisdiction B"]] -
          max(ReOpen_TransitionDays[["Jurisdiction B"]]) +
          Third.Wave.Reopening.End[["Jun"]]["Jurisdiction B"])
    )
    
  )


# Third.Wave.Magnitude: proportional to the magnitude of the increase in contact rates when community mitigation measures are lifted in the fall

Third.Wave.Magnitude =
  list(
    "0.35" = list(
      
      "National" = c("Dec" = 1.57, "Feb" = 2.3-0.1, "Apr" = 2.575),
        
      "Jurisdiction A" = c("Dec" = 2.97, "Feb" = 3.5, "Apr" = 3.69),
      
      "Jurisdiction B" = c("Dec" = 1.025, "Feb" = 1.4, "Apr" =1.7)
    ),
    "0.2" = list(
      "National" = c("Dec" = 1.6, "Feb" = 2.375, "Apr" = 2.78),
      
      "Jurisdiction A" = c("Dec" = 2.98, "Feb" = 3.51, "Apr" = 3.69),
      
      "Jurisdiction B" = c("Dec" = 1, "Feb" = 1.45, "Apr" =1.8)
    ),
    
    "0.5" = list(
      "National" = c("Dec" = 1.55, "Feb" = 2.15-0.05, "Apr" = 2.45),
      
      "Jurisdiction A" = c("Dec" = 2.95, "Feb" = 3.5, "Apr" = 3.69),
      
      "Jurisdiction B" = c("Dec" = 1.05, "Feb" = 1.375, "Apr" =1.65)
    )
  )

```

**Defining Scenarios to Run the Model For**

Instructions:
* Comment out line X, and the comma in the line above, to only run the scenarios 
with no vaccination. 

* Examine the plots in the section after next (**Examine Daily/Cumulative Incidence and Rt in Each Setting**)

* Adjust the parameters in the prior section (**Defining the Timing and Strength of Community Mitigation Phases**) as desired before running again with the vaccine scenarios, which can take a while.

```{r}
# define set of scenarios to run the compartmental model for

Scenarios = 
  expand.grid(
    Setting = c("National", "Jurisdiction A", "Jurisdiction B"),
    Vax_Priority = c("Elderly","HighRisk","Essential"),
    Immunogenicity.Elderly = c("Full","Half"),
    Essential.Worker.Distancing = c(0.35, 0.2, 0.5),
    Third.Wave.Peak = c("Dec","Feb", "Apr"),
    Mode.of.Action = c("Infection Blocking","Disease Blocking"),
    Excess.Risk.Severe = c("Mid.RR")
  )
vax_scenarios = nrow(Scenarios)

Scenarios = 
  rbind(
    expand.grid(
      Setting = c("National", "Jurisdiction A", "Jurisdiction B"),
      Vax_Priority = c("No Vaccination"),
      Immunogenicity.Elderly = NA,
    Essential.Worker.Distancing = c(0.35, 0.2, 0.5),
      Third.Wave.Peak = c("Dec","Feb","Apr"),
      Mode.of.Action = NA,
      Excess.Risk.Severe = c("Mid.RR")
    ),
    Scenarios 
  ) %>% 
  mutate(Total.Infections=NA,
         Total.Infections.2021=NA,
         Total.Hospitalizations=NA,
         Total.Hospitalizations.2021=NA,
         Total.Deaths=NA,
         Total.Deaths.2021=NA,
         Infections.6months.postIntro=NA,
         Deaths.6months.postIntro=NA,
         Deaths.6months.postIntro.0to49=NA,
         Deaths.6months.postIntro.50to64=NA,
         Deaths.6months.postIntro.65plus=NA,
         Hospitalizations.6months.postIntro=NA,
         Hospitalizations.6months.postIntro.0to49=NA,
         Hospitalizations.6months.postIntro.50to64=NA,
         Hospitalizations.6months.postIntro.65plus=NA,
         YLL.6months.postIntro=NA)

total_scenarios = nrow(Scenarios)
non_vax_scenarios = total_scenarios-vax_scenarios
Scenarios$Setting=as.character(Scenarios$Setting)
Scenarios$Third.Wave.Peak = as.character(Scenarios$Third.Wave.Peak)
Scenarios$Mode.of.Action = as.character(Scenarios$Mode.of.Action)
Scenarios$Excess.Risk.Severe = as.character(Scenarios$Excess.Risk.Severe)

Scenarios.low = Scenarios %>% mutate(Excess.Risk.Severe="Low.RR")
Scenarios.high = Scenarios %>% mutate(Excess.Risk.Severe="High.RR")
```

**Running the Compartmental Model**

```{r, cache = T, warning=F}



HighMitigation_DailyInc = 
  matrix(nrow = nrow(Scenarios),
         ncol = central_scenario$simulationLength+31)

HighMitigation_CumulativeInc = 
  matrix(nrow = nrow(Scenarios),
         ncol = central_scenario$simulationLength+31)

HighMitigation_CumulativeInc.Essential = 
  matrix(nrow = nrow(Scenarios),
         ncol = central_scenario$simulationLength+31)

R.ts = 
  matrix(nrow = nrow(Scenarios),
         ncol = central_scenario$simulationLength+31)

Prev = 
  matrix(nrow = nrow(Scenarios),
         ncol = central_scenario$simulationLength+31)


for(i in 1:nrow(Scenarios))
{
  rm(Baseline, 
     FullMitigation, 
     HighMitigation, 
     HighMitigation_SchoolsClosed,
     ModerateMitigation)
  
  
  Baseline = matrix(0,nrow=14,ncol=14,dimnames=list(strata.names,strata.names))
  FullMitigation = matrix(0,nrow=14,ncol=14,dimnames=list(strata.names,strata.names))
  HighMitigation = matrix(0,nrow=14,ncol=14,dimnames=list(strata.names,strata.names))
  HighMitigation_SchoolsClosed =
    matrix(0,nrow=14,ncol=14,dimnames=list(strata.names,strata.names))
  ModerateMitigation = matrix(0,nrow=14,ncol=14,dimnames=list(strata.names,strata.names))
  LowMitigation = matrix(0,nrow=14,ncol=14,dimnames=list(strata.names,strata.names))
  
  for(j in names(Baseline_Matrices))
  {
    Baseline =
      Baseline + 
      expand.contact.matrix(contact.matrix = Baseline_Matrices[[j]],
                            baseline.contact.matrix = Baseline_Matrices[[j]],
                            is.Work.Matrix = ifelse(j=="Work",TRUE,FALSE),
                            frac.adults.essential = frac.adults.essential,
                            frac.adults.high.risk = c(0.316 , 0.481, 0.555, 0.547),
                            essential.distancing =
                              Scenarios$Essential.Worker.Distancing[i])
  }
  
  for(j in names(Full_Mitigation_Matrices))
  {
    FullMitigation = 
      FullMitigation +
      expand.contact.matrix(contact.matrix = Full_Mitigation_Matrices[[j]],
                            baseline.contact.matrix =
                              Baseline_Matrices[[j]],
                            is.Work.Matrix = ifelse(j=="Work",TRUE,FALSE),
                            frac.adults.essential = frac.adults.essential ,
                            frac.adults.high.risk = c(0.316 , 0.481, 0.555, 0.547),
                            essential.distancing =
                              Scenarios$Essential.Worker.Distancing[i])
  }
  
  
  
  for(j in names(High_Mitigation_Matrices))
  {
    HighMitigation = 
      HighMitigation +
      expand.contact.matrix(contact.matrix = High_Mitigation_Matrices[[j]],
                            baseline.contact.matrix =
                              Baseline_Matrices[[j]],
                            is.Work.Matrix = ifelse(j=="Work",TRUE,FALSE),
                            frac.adults.essential = frac.adults.essential,
                            frac.adults.high.risk = c(0.316 , 0.481, 0.555, 0.547),
                            essential.distancing =
                              Scenarios$Essential.Worker.Distancing[i])
  }
  
  for(j in names(High_Mitigation_SchoolClosed_Matrices))
  {
    HighMitigation_SchoolsClosed = 
      HighMitigation_SchoolsClosed +
      expand.contact.matrix(contact.matrix =
                              High_Mitigation_SchoolClosed_Matrices[[j]],
                            baseline.contact.matrix =
                              Baseline_Matrices[[j]],
                            is.Work.Matrix = ifelse(j=="Work",TRUE,FALSE),
                            frac.adults.essential = frac.adults.essential,
                            frac.adults.high.risk = c(0.316 , 0.481, 0.555, 0.547),
                            essential.distancing =
                              Scenarios$Essential.Worker.Distancing[i])
  }
  
  for(j in names(Low_Mitigation_Matrices))
  {
    LowMitigation = 
      LowMitigation +
      expand.contact.matrix(contact.matrix =
                              Low_Mitigation_Matrices[[j]],
                            baseline.contact.matrix =
                              Baseline_Matrices[[j]],
                            is.Work.Matrix = ifelse(j=="Work",TRUE,FALSE),
                            frac.adults.essential = frac.adults.essential ,
                            frac.adults.high.risk = c(0.316 , 0.481, 0.555, 0.547),
                            essential.distancing =
                              Scenarios$Essential.Worker.Distancing[i])
  }
  
  for(j in names(Moderate_Mitigation_Matrices))
  {
    ModerateMitigation = 
      ModerateMitigation +
      expand.contact.matrix(contact.matrix =
                              Moderate_Mitigation_Matrices[[j]],
                            baseline.contact.matrix =
                              Baseline_Matrices[[j]],
                            is.Work.Matrix = ifelse(j=="Work",TRUE,FALSE),
                            frac.adults.essential = frac.adults.essential,
                            frac.adults.high.risk = c(0.316 , 0.481, 0.555, 0.547),
                            essential.distancing =
                              Scenarios$Essential.Worker.Distancing[i])
  }
  
  # last.reopening.day: the number of days during which contact rates gradually increase, once reopening begins in the late spring / early summer
  last.reopening.day = 
    1+Pause.Day[[Scenarios$Setting[i]]]-
    min(ReOpen_TransitionDays[[Scenarios$Setting[i]]])
  
  last.reopening.day = 
    min(last.reopening.day,
      length(ReOpen_TransitionDays[[Scenarios$Setting[i]]]))
  
  Scenario = c(list(Baseline),
               
               Gradual_ContactMatrix(
                 StartMatrix = Baseline,
                 EndMatrix = FullMitigation,
                 TransitionDays =
                   StayHome_TransitionDays[[Scenarios$Setting[i]]]),
               
               head(Gradual_ContactMatrix(
                 StartMatrix = FullMitigation,
                 EndMatrix = 
                   FullMitigation +
                   ReOpening.Intensity[Scenarios$Setting[i]]*(HighMitigation-FullMitigation),
        TransitionDays =
             ReOpen_TransitionDays[[Scenarios$Setting[i]]]),
                  last.reopening.day))
  
  
  
  Post.Pause.matrix = 
    Scenario[[length(Scenario)]] -
    (Post.Pause.Reversion.Factor[[Scenarios$Setting[i]]]*
       (Scenario[[length(Scenario)]]-FullMitigation))
  
  Scenario = c(Scenario, 
               
               Gradual_ContactMatrix(
                 StartMatrix = Scenario[[length(Scenario)]],
                 EndMatrix = Post.Pause.matrix,
                 TransitionDays = seq(Pause.Day[[Scenarios$Setting[i]]],
                                      Post.Pause.End.Day[[Scenarios$Setting[i]]],
                                      1)))
  
  ReOpen_TransitionDays_Third.Wave =
    seq(Third.Wave.Reopening.End[[as.character(Scenarios$Third.Wave.Peak[i])]][Scenarios$Setting[i]]-
          (length(ReOpen_TransitionDays[[Scenarios$Setting[i]]])-1),
        Third.Wave.Reopening.End[[as.character(Scenarios$Third.Wave.Peak[i])]][Scenarios$Setting[i]])
  
  last.reopening.day.third.wave = 
    1+Pause.Day.Third.Wave[[Scenarios$Setting[i]]][as.character(Scenarios$Third.Wave.Peak[i])]-
    min(ReOpen_TransitionDays_Third.Wave)

  
  Scenario = 
    c(Scenario,
      
      head(Gradual_ContactMatrix(
        StartMatrix = Post.Pause.matrix,
        EndMatrix = Post.Pause.matrix + 
          min(1,Third.Wave.Magnitude[[as.character(Scenarios$Essential.Worker.Distancing[i])]][[Scenarios$Setting[i]]][as.character(Scenarios$Third.Wave.Peak[i])])*(HighMitigation-Post.Pause.matrix) +
          min(max(0,Third.Wave.Magnitude[[as.character(Scenarios$Essential.Worker.Distancing[i])]][[Scenarios$Setting[i]]][as.character(Scenarios$Third.Wave.Peak[i])]-1),1)*(ModerateMitigation-HighMitigation) +
          
          min(max(0,Third.Wave.Magnitude[[as.character(Scenarios$Essential.Worker.Distancing[i])]][[Scenarios$Setting[i]]][as.character(Scenarios$Third.Wave.Peak[i])]-2),1)*(LowMitigation-ModerateMitigation) + 
          
          min(max(0,Third.Wave.Magnitude[[as.character(Scenarios$Essential.Worker.Distancing[i])]][[Scenarios$Setting[i]]][as.character(Scenarios$Third.Wave.Peak[i])]-3),1)*(Baseline-LowMitigation)
        
        ,
        TransitionDays =
          ReOpen_TransitionDays_Third.Wave),

        min(last.reopening.day.third.wave,
            length(ReOpen_TransitionDays_Third.Wave))
        
      ))
  
  Post.Pause.matrix_third.Wave = 
    Scenario[[length(Scenario)]] -
    (Post.Pause.Reversion.Factor_Third.Wave[[Scenarios$Setting[i]]]*
       (Scenario[[length(Scenario)]]-FullMitigation))
  
  Post.Pause.End.Day.third.wave =
    Pause.Day.Third.Wave[[Scenarios$Setting[i]]][as.character(Scenarios$Third.Wave.Peak[i])] +
    Post.Pause.End.Day[[Scenarios$Setting[i]]] - 
    Pause.Day[[Scenarios$Setting[i]]]
  
  Scenario = c(Scenario, 
               
               Gradual_ContactMatrix(
                 StartMatrix = Scenario[[length(Scenario)]],
                 EndMatrix = Post.Pause.matrix_third.Wave,
                 TransitionDays = seq(Pause.Day.Third.Wave[[Scenarios$Setting[i]]][as.character(Scenarios$Third.Wave.Peak[i])],
                                      Post.Pause.End.Day.third.wave,
                                      1)))
  
  Pars = central_scenario
  
  
  Pars$R0 = Baseline.R0[[Scenarios$Setting[i]]]
  
  Pars$ContactMatrices = Scenario
  Pars$ContactMatrixStartDay = c(
    as.numeric(as.Date("2020-01-01") - as.Date("2020-01-01")),
    StayHome_TransitionDays[[Scenarios$Setting[i]]],
    
    ReOpen_TransitionDays[[Scenarios$Setting[i]]][1:min(last.reopening.day,
                                                        length(ReOpen_TransitionDays[[Scenarios$Setting[i]]]))],
    
    seq(Pause.Day[[Scenarios$Setting[i]]],
        Post.Pause.End.Day[[Scenarios$Setting[i]]],1),
    
    ReOpen_TransitionDays_Third.Wave[1:min(last.reopening.day.third.wave, length(ReOpen_TransitionDays_Third.Wave))],      

    seq(Pause.Day.Third.Wave[[Scenarios$Setting[i]]][as.character(Scenarios$Third.Wave.Peak[i])],
        Post.Pause.End.Day.third.wave,1)
    
  )
  
  
  
  EssentialWorkers=Essential/3300 # here and in other parts of the analysis, multiplication and division by 3,300 is performed to convert between the size of the US population (330 million) and the population size in the model (100 thousand, selected for interpretability).
  
  EssentialHCW=20000000/3300
  Pars$tolerance=(1e-8)/10
  
  if(Scenarios$Vax_Priority[i] != "No Vaccination")
  {
    Pars$vaccineEfficacyDelay = 14
    Pars$boostDelay=28
    Pars$vaccineAdministrationRatePerDay = 10E6/(3300*7)
    Pars$vaccineAvailabilityByDayPrime = rep(0,365*2)
    
    # first 
    vaxDay = 1+as.numeric(as.Date("2021-01-01")-as.Date("2020-01-01"))  # first day of 2021
    Pars$vaccineAvailabilityByDayPrime[vaxDay] =  EssentialHCW
    
    vaxDay = vaxDay + 
      28 + 
      ceiling(EssentialHCW/Pars$vaccineAdministrationRatePerDay)   # day after last HCW receives thier 2nd dose
    Pars$vaccineAvailabilityByDayPrime[vaxDay] =  (60E6/3300)-EssentialHCW
    Pars$vaccineUptakeMultiplierStartDay = c(0, vaxDay)
    
    
    
    vaxDay = 
      vaxDay + 
      ceiling(((60E6/3300)-EssentialHCW)/Pars$vaccineAdministrationRatePerDay)    #+28 # day after last person in tier 1b receives their 1st dose 
    
    Pars$vaccineAvailabilityByDayPrime[vaxDay] =  
      sum(basePars$populationFractions[Phase1B.strata])*100E3-(60E6/3300)
    Pars$vaccineUptakeMultiplierStartDay =
      c(Pars$vaccineUptakeMultiplierStartDay, vaxDay)
    
    
    
    vaxDay = vaxDay  + 
      ceiling(((60E6/3300)-
                 EssentialHCW +            
               2*(sum(basePars$populationFractions[Phase1B.strata])*100E3-(60E6/3300)))/Pars$vaccineAdministrationRatePerDay)
    
    Pars$vaccineUptakeMultiplierStartDay =
      c(Pars$vaccineUptakeMultiplierStartDay, vaxDay)
    
    Pars$vaccineAvailabilityByDayPrime[vaxDay] =
      100E3 * 
      (1 - 
         sum(basePars$populationFractions[Phase1B.strata]
         )  
      )
    
    
    Pars$vaccineAvailabilityByDayBoost = Pars$vaccineAvailabilityByDayPrime
    
    
    Pars$vaccineUptakeMultipliers = list(rep(0,14),
                                         rep(0,14),
                                         rep(0,14),
                                         rep(1,14))
    
    Pars$vaccineUptakeMultipliers[[1]][grep("Risk.Essential",strata.names)]=1
    
    if(Scenarios$Vax_Priority[i]=="Elderly")
    {Pars$vaccineUptakeMultipliers[[2]][c(grep("Age65to74",strata.names),grep("Age75plus",strata.names))]=1}
    
    if(Scenarios$Vax_Priority[i]=="Essential")
    {
    Pars$vaccineUptakeMultipliers[[2]][grep("Risk.Essential",strata.names)]=1
    }
    
    if(Scenarios$Vax_Priority[i]=="HighRisk")
    {
      Pars$vaccineUptakeMultipliers[[2]][grep(".HighRisk.",strata.names)]=1
    }
    
    Pars$vaccineUptakeMultipliers[[3]][Phase1B.strata]=1
    
    if(!is.na(Scenarios$Mode.of.Action[i]))
    {
      if(Scenarios$Mode.of.Action[i] == "Infection Blocking")
      {
        Pars$VEs2 = rep(0.9,14)
        Pars$VEs2[elderly.strata]=
          ifelse(Scenarios$Immunogenicity.Elderly[i] == "Half",0.9/2, 0.9)
        Pars$VEs1 = Pars$VEs2/4
        
        Pars$VEp1 = 0  
        Pars$VEp2 = 0  
      }
      
      if(Scenarios$Mode.of.Action[i] == "Disease Blocking")
      {
        Pars$VEp2 = rep(0.9,14)
        Pars$VEp2[elderly.strata]=
          ifelse(Scenarios$Immunogenicity.Elderly[i] == "Half",0.9/2, 0.9)
        Pars$VEp1 = Pars$VEp2/4
        
        Pars$VEs1 = 0  
        Pars$VEs2 = 0  
      }   
    }
    
    
  }
  
  
  
  Model =do.call(SEAIRTVModel,
                 c(Pars,
                   list(
                     seedStartDay =
                       filter(DataFrame, Setting==Scenarios$Setting[i])$SeedDay,
                     Seasonality=F
                   )))
  
  
  # Get Infections
  Infections = getInfectionTimeSeries(Model,
                                      incidence=T,
                                      byGroup = F)
  Infections[which(is.na(Infections))] =0
  Infections= Infections[1:min(length(Infections),ncol(HighMitigation_DailyInc))]
  
  Infections.Essential = 
    getInfectionTimeSeries(Model, incidence=T, byGroup = T)
  
  Infections.Essential[which(is.na(Infections.Essential))] =0
  
  Infections.Essential = 
    rowSums(Infections.Essential[,grep("Risk.Essential",strata.names)])/sum(Pars$populationFractions[grep("Risk.Essential",strata.names)])
  
  Infections.Essential=
    Infections.Essential[1:min(length(Infections.Essential),ncol(HighMitigation_DailyInc))]
  
  HighMitigation_DailyInc[i, 1:length(Infections)] = Infections
  HighMitigation_CumulativeInc[i, 1:length(Infections)] = cumsum(Infections)
  HighMitigation_CumulativeInc.Essential[i, 1:length(Infections.Essential)] =
    cumsum(Infections.Essential)
  
  Prev[i, 1:length(Infections)] = 
    getInfectionTimeSeries(Model, incidence=F,  byGroup = F)[1:length(Infections)]
  
  
  
  R.ts[i,1:length(Infections)] = getRTimeSeries(Model, actual=F)[1:length(Infections)]
  
  Scenarios$Total.Infections[i]=sum(Infections,na.rm=T)
  Scenarios.low$Total.Infections[i]=Scenarios$Total.Infections[i]
  Scenarios.high$Total.Infections[i]=Scenarios$Total.Infections[i]
  
  Scenarios$Total.Infections.2021[i] = 
    sum(Infections[(1+as.numeric(as.Date("2021-01-01")-as.Date("2020-01-01"))):length(Infections)],  
        na.rm = T)
  
  Scenarios.low$Total.Infections.2021[i] = Scenarios$Total.Infections.2021[i]
  
  Scenarios.high$Total.Infections.2021[i] = Scenarios$Total.Infections.2021[i]
  
  
  
  

  
  
  
  
  Scenarios$Infections.6months.postIntro[i] =
    sum(Infections[367:(367+181)],na.rm=T)
  
  Scenarios.low$Infections.6months.postIntro[i] =
    Scenarios$Infections.6months.postIntro[i]
  
  Scenarios.high$Infections.6months.postIntro[i] = 
    Scenarios$Infections.6months.postIntro[i]
  
  
  
  PeakDay = switch(Scenarios$Third.Wave.Peak[i],
                   "Dec"=as.numeric(as.Date("2020-12-01")-as.Date("2020-01-01"))+1,
                   "Feb"=as.numeric(as.Date("2021-02-01")-as.Date("2020-01-01"))+1,
                   "Apr"=as.numeric(as.Date("2021-04-01")-as.Date("2020-01-01"))+1,
                   "Jun"=as.numeric(as.Date("2021-06-01")-as.Date("2020-01-01"))+1)
  

  # Get Hospitalizations
  Hospitalizations = getHospitalizations(Model,byGroup = F,
                                         caseHospitalizationRatio =
                                           Pars$caseHospitalizationRatio,
                                         timeSeries = T)
  
  Hospitalizations[which(is.na(Hospitalizations)|Hospitalizations<0)]=0
  Hospitalizations= Hospitalizations[1:length(Infections)]
  
  Scenarios$Total.Hospitalizations[i] = sum(Hospitalizations,na.rm=T)
  Scenarios$Total.Hospitalizations.2021[i] =
    sum(Hospitalizations[(1+as.numeric(as.Date("2021-01-01")-as.Date("2020-01-01"))):length(Infections)],na.rm=T)
  
  # Get Deaths
  Deaths = getDeaths(Model,byGroup = F,
                     caseFatalityRatio =  CFR.LIST[["Mid.RR"]],
                     timeSeries = T)
  
  Deaths.low = getDeaths(Model,byGroup = F,
                         caseFatalityRatio =  CFR.LIST[["Low.RR"]],
                         timeSeries = T)
  
  Deaths.high = getDeaths(Model,byGroup = F,
                          caseFatalityRatio =  CFR.LIST[["High.RR"]],
                          timeSeries = T)
  
  Deaths.0to49 = getDeaths(Model,byGroup = T,
                     caseFatalityRatio =  CFR.LIST[["Mid.RR"]],
                     timeSeries = T)[,c(grep("0to4",strata.names),
                                       grep("5to17",strata.names),
                                       grep("18to49",strata.names))] %>% 
                      rowSums()
  
  Deaths.low.0to49 = getDeaths(Model,byGroup = T,
                     caseFatalityRatio =  CFR.LIST[["Low.RR"]],
                     timeSeries = T)[,c(grep("0to4",strata.names),
                                       grep("5to17",strata.names),
                                grep("18to49",strata.names))] %>% 
                      rowSums()
  
  Deaths.high.0to49 = getDeaths(Model,byGroup = T,
                     caseFatalityRatio =  CFR.LIST[["High.RR"]],
                     timeSeries = T)[,c(grep("0to4",strata.names),
                                       grep("5to17",strata.names),
                                   grep("18to49",strata.names))] %>% 
                      rowSums()
  
  Deaths.50to64 = getDeaths(Model,byGroup = T,
                     caseFatalityRatio =  CFR.LIST[["Mid.RR"]],
                     timeSeries = T)[,grep("50to64",strata.names)] %>% 
                      rowSums()
  
  Deaths.low.50to64 = getDeaths(Model,byGroup = T,
                     caseFatalityRatio =  CFR.LIST[["Low.RR"]],
                     timeSeries = T)[,grep("50to64",strata.names)] %>% 
                      rowSums()
  
  Deaths.high.50to64 = getDeaths(Model,byGroup = T,
                     caseFatalityRatio =  CFR.LIST[["High.RR"]],
                     timeSeries = T)[,grep("50to64",strata.names)] %>% 
                      rowSums()
  
  
  
  Deaths.65plus = getDeaths(Model,byGroup = T,
                     caseFatalityRatio =  CFR.LIST[["Mid.RR"]],
                     timeSeries = T)[,c(grep("Age65to74",strata.names),grep("Age75plus",strata.names))] %>% 
                      rowSums()
  
  Deaths.low.65plus = getDeaths(Model,byGroup = T,
                     caseFatalityRatio =  CFR.LIST[["Low.RR"]],
                     timeSeries = T)[,c(grep("Age65to74",strata.names),grep("Age75plus",strata.names))] %>% 
                      rowSums()
  
  Deaths.high.65plus = getDeaths(Model,byGroup = T,
                     caseFatalityRatio =  CFR.LIST[["High.RR"]],
                     timeSeries = T)[,c(grep("Age65to74",strata.names),grep("Age75plus",strata.names))] %>% 
                      rowSums()
  
  
  Deaths[which(is.na(Deaths)|Deaths<0)]=0
  Deaths.0to49[which(is.na(Deaths.0to49)|Deaths.0to49<0)]=0
  Deaths.50to64[which(is.na(Deaths.50to64)|Deaths.50to64<0)]=0
  Deaths.65plus[which(is.na(Deaths.65plus)|Deaths.65plus<0)]=0

  
  Deaths.low[which(is.na(Deaths)|Deaths<0)]=0
  Deaths.high[which(is.na(Deaths)|Deaths<0)]=0
  Deaths.low.0to49[which(is.na(Deaths.0to49)|Deaths.0to49<0)]=0
  Deaths.high.0to49[which(is.na(Deaths.0to49)|Deaths.0to49<0)]=0
  Deaths.low.50to64[which(is.na(Deaths.50to64)|Deaths.50to64<0)]=0
  Deaths.high.50to64[which(is.na(Deaths.50to64)|Deaths.50to64<0)]=0
  Deaths.low.65plus[which(is.na(Deaths.65plus)|Deaths.65plus<0)]=0
  Deaths.high.65plus[which(is.na(Deaths.65plus)|Deaths.65plus<0)]=0
  
  Deaths = Deaths[1:length(Infections)]
  Deaths.low = Deaths.low[1:length(Infections)]
  Deaths.high = Deaths.high[1:length(Infections)]
  Deaths.0to49 = Deaths.0to49[1:length(Infections)]
  Deaths.low.0to49 = Deaths.low.0to49[1:length(Infections)]
  Deaths.high.0to49 = Deaths.high.0to49[1:length(Infections)]
  Deaths.50to64 = Deaths.50to64[1:length(Infections)]
  Deaths.low.50to64 = Deaths.low.50to64[1:length(Infections)]
  Deaths.high.50to64 = Deaths.high.50to64[1:length(Infections)]
  Deaths.65plus = Deaths.65plus[1:length(Infections)]
  Deaths.low.65plus = Deaths.low.65plus[1:length(Infections)]
  Deaths.high.65plus = Deaths.high.65plus[1:length(Infections)]
  
  Scenarios$Total.Deaths[i] = sum(Deaths,na.rm=T)
  Scenarios.low$Total.Deaths[i] = sum(Deaths.low,na.rm=T)
  Scenarios.high$Total.Deaths[i] = sum(Deaths.high,na.rm=T)
  
  Scenarios$Total.Deaths.2021[i] =
    sum(Deaths[(1+as.numeric(as.Date("2021-01-01")-as.Date("2020-01-01"))):length(Infections)],  na.rm=T)
  
  Scenarios.low$Total.Deaths.2021[i] =
    sum(Deaths.low[(1+as.numeric(as.Date("2021-01-01")-as.Date("2020-01-01"))):length(Infections)],  na.rm=T)
  
  Scenarios.high$Total.Deaths.2021[i] =
    sum(Deaths.high[(1+as.numeric(as.Date("2021-01-01")-as.Date("2020-01-01"))):length(Infections)], 
        na.rm=T)
  

  Scenarios$Deaths.6months.postIntro[i] =
    sum(Deaths[367:(367+181)],na.rm=T)
  Scenarios.low$Deaths.6months.postIntro[i] =
    sum(Deaths.low[367:(367+181)],na.rm=T)
  Scenarios.high$Deaths.6months.postIntro[i] =
    sum(Deaths.high[367:(367+181)],na.rm=T)  
  
  Scenarios$Deaths.6months.postIntro.0to49[i] =
    sum(Deaths.0to49[367:(367+181)],na.rm=T)
  Scenarios.low$Deaths.6months.postIntro.0to49[i] =
    sum(Deaths.low.0to49[367:(367+181)],na.rm=T)
  Scenarios.high$Deaths.6months.postIntro.0to49[i] =
    sum(Deaths.high.0to49[367:(367+181)],na.rm=T)  
  
  Scenarios$Deaths.6months.postIntro.50to64[i] =
    sum(Deaths.50to64[367:(367+181)],na.rm=T)
  Scenarios.low$Deaths.6months.postIntro.50to64[i] =
    sum(Deaths.low.50to64[367:(367+181)],na.rm=T)
  Scenarios.high$Deaths.6months.postIntro.50to64[i] =
    sum(Deaths.high.50to64[367:(367+181)],na.rm=T)  
  
  Scenarios$Deaths.6months.postIntro.65plus[i] =
    sum(Deaths.65plus[367:(367+181)],na.rm=T)
  Scenarios.low$Deaths.6months.postIntro.65plus[i] =
    sum(Deaths.low.65plus[367:(367+181)],na.rm=T)
  Scenarios.high$Deaths.6months.postIntro.65plus[i] =
    sum(Deaths.high.65plus[367:(367+181)],na.rm=T)  
  
  # Get Hospitalizations
  Hospitalizations = getHospitalizations(Model,byGroup = F,
                     caseHospitalizationRatio =  CHR.LIST[["Mid.RR"]],
                     timeSeries = T)
  
  Hospitalizations.low = getHospitalizations(Model,byGroup = F,
                         caseHospitalizationRatio =  CHR.LIST[["Low.RR"]],
                         timeSeries = T)
  
  Hospitalizations.high = getHospitalizations(Model,byGroup = F,
                          caseHospitalizationRatio =  CHR.LIST[["High.RR"]],
                          timeSeries = T)
  
  Hospitalizations.0to49 = getHospitalizations(Model,byGroup = T,
                     caseHospitalizationRatio =  CHR.LIST[["Mid.RR"]],
                     timeSeries = T)[,c(grep("0to4",strata.names),
                                       grep("5to17",strata.names),
                                     grep("18to49",strata.names))] %>% 
                      rowSums()
  
  Hospitalizations.low.0to49 = getHospitalizations(Model,byGroup = T,
                     caseHospitalizationRatio =  CHR.LIST[["Low.RR"]],
                     timeSeries = T)[,c(grep("0to4",strata.names),
                                       grep("5to17",strata.names),
                                       grep("18to49",strata.names))] %>% 
                      rowSums()
  
  Hospitalizations.high.0to49 = getHospitalizations(Model,byGroup = T,
                     caseHospitalizationRatio =  CHR.LIST[["High.RR"]],
                     timeSeries = T)[,c(grep("0to4",strata.names),
                                       grep("5to17",strata.names),
                                       grep("18to49",strata.names))] %>% 
                      rowSums()
  
  Hospitalizations.50to64 = getHospitalizations(Model,byGroup = T,
                     caseHospitalizationRatio =  CHR.LIST[["Mid.RR"]],
                     timeSeries = T)[,grep("50to64",strata.names)] %>% 
                      rowSums()
  
  Hospitalizations.low.50to64 = getHospitalizations(Model,byGroup = T,
                     caseHospitalizationRatio =  CHR.LIST[["Low.RR"]],
                     timeSeries = T)[,grep("50to64",strata.names)] %>% 
                      rowSums()
  
  Hospitalizations.high.50to64 = getHospitalizations(Model,byGroup = T,
                     caseHospitalizationRatio =  CHR.LIST[["High.RR"]],
                     timeSeries = T)[,grep("50to64",strata.names)] %>% 
                      rowSums()
  
  
  
  Hospitalizations.65plus = getHospitalizations(Model,byGroup = T,
                     caseHospitalizationRatio =  CHR.LIST[["Mid.RR"]],
                     timeSeries = T)[,c(grep("Age65to74",strata.names),grep("Age75plus",strata.names))] %>% 
                      rowSums()
  
  Hospitalizations.low.65plus = getHospitalizations(Model,byGroup = T,
                     caseHospitalizationRatio =  CHR.LIST[["Low.RR"]],
                     timeSeries = T)[,c(grep("Age65to74",strata.names),grep("Age75plus",strata.names))] %>% 
                      rowSums()
  
  Hospitalizations.high.65plus = getHospitalizations(Model,byGroup = T,
                     caseHospitalizationRatio =  CHR.LIST[["High.RR"]],
                     timeSeries = T)[,c(grep("Age65to74",strata.names),grep("Age75plus",strata.names))] %>% 
                      rowSums()
  
  
  Hospitalizations[which(is.na(Hospitalizations)|Hospitalizations<0)]=0
  Hospitalizations.0to49[which(is.na(Hospitalizations.0to49)|Hospitalizations.0to49<0)]=0
  Hospitalizations.50to64[which(is.na(Hospitalizations.50to64)|Hospitalizations.50to64<0)]=0
  Hospitalizations.65plus[which(is.na(Hospitalizations.65plus)|Hospitalizations.65plus<0)]=0

  
  Hospitalizations.low[which(is.na(Hospitalizations)|Hospitalizations<0)]=0
  Hospitalizations.high[which(is.na(Hospitalizations)|Hospitalizations<0)]=0
  Hospitalizations.low.0to49[which(is.na(Hospitalizations.0to49)|Hospitalizations.0to49<0)]=0
  Hospitalizations.high.0to49[which(is.na(Hospitalizations.0to49)|Hospitalizations.0to49<0)]=0
  Hospitalizations.low.50to64[which(is.na(Hospitalizations.50to64)|Hospitalizations.50to64<0)]=0
  Hospitalizations.high.50to64[which(is.na(Hospitalizations.50to64)|Hospitalizations.50to64<0)]=0
  Hospitalizations.low.65plus[which(is.na(Hospitalizations.65plus)|Hospitalizations.65plus<0)]=0
  Hospitalizations.high.65plus[which(is.na(Hospitalizations.65plus)|Hospitalizations.65plus<0)]=0
  
  Hospitalizations = Hospitalizations[1:length(Infections)]
  Hospitalizations.low = Hospitalizations.low[1:length(Infections)]
  Hospitalizations.high = Hospitalizations.high[1:length(Infections)]
  Hospitalizations.0to49 = Hospitalizations.0to49[1:length(Infections)]
  Hospitalizations.low.0to49 = Hospitalizations.low.0to49[1:length(Infections)]
  Hospitalizations.high.0to49 = Hospitalizations.high.0to49[1:length(Infections)]
  Hospitalizations.50to64 = Hospitalizations.50to64[1:length(Infections)]
  Hospitalizations.low.50to64 = Hospitalizations.low.50to64[1:length(Infections)]
  Hospitalizations.high.50to64 = Hospitalizations.high.50to64[1:length(Infections)]
  Hospitalizations.65plus = Hospitalizations.65plus[1:length(Infections)]
  Hospitalizations.low.65plus = Hospitalizations.low.65plus[1:length(Infections)]
  Hospitalizations.high.65plus = Hospitalizations.high.65plus[1:length(Infections)]
  
   Scenarios$Hospitalizations.6months.postIntro[i] =
    sum(Hospitalizations[367:(367+181)],na.rm=T)
  Scenarios.low$Hospitalizations.6months.postIntro[i] =
    sum(Hospitalizations.low[367:(367+181)],na.rm=T)
  Scenarios.high$Hospitalizations.6months.postIntro[i] =
    sum(Hospitalizations.high[367:(367+181)],na.rm=T)  
  
  Scenarios$Hospitalizations.6months.postIntro.0to49[i] =
    sum(Hospitalizations.0to49[367:(367+181)],na.rm=T)
  Scenarios.low$Hospitalizations.6months.postIntro.0to49[i] =
    sum(Hospitalizations.low.0to49[367:(367+181)],na.rm=T)
  Scenarios.high$Hospitalizations.6months.postIntro.0to49[i] =
    sum(Hospitalizations.high.0to49[367:(367+181)],na.rm=T)  
  
  Scenarios$Hospitalizations.6months.postIntro.50to64[i] =
    sum(Hospitalizations.50to64[367:(367+181)],na.rm=T)
  Scenarios.low$Hospitalizations.6months.postIntro.50to64[i] =
    sum(Hospitalizations.low.50to64[367:(367+181)],na.rm=T)
  Scenarios.high$Hospitalizations.6months.postIntro.50to64[i] =
    sum(Hospitalizations.high.50to64[367:(367+181)],na.rm=T)  
  
  Scenarios$Hospitalizations.6months.postIntro.65plus[i] =
    sum(Hospitalizations.65plus[367:(367+181)],na.rm=T)
  Scenarios.low$Hospitalizations.6months.postIntro.65plus[i] =
    sum(Hospitalizations.low.65plus[367:(367+181)],na.rm=T)
  Scenarios.high$Hospitalizations.6months.postIntro.65plus[i] =
    sum(Hospitalizations.high.65plus[367:(367+181)],na.rm=T)  
  

  # years of life lost 
  
  Scenarios$YLL.6months.postIntro[i] = 
    sum(colSums(getDeaths(Model,byGroup = T,
              caseFatalityRatio =  CFR.LIST[["Mid.RR"]],
              timeSeries = T)[367:(367+181),])*Remaining.Years.Life.Expanded)
  
}

Scenarios = 
  rbind(Scenarios,
        Scenarios.low,
        Scenarios.high)

```

# Analysing Model Outputs

**Examine Daily/Cumulative Incidence and Rt in Each Setting**

```{r, fig.height = 10}

 par(mfrow=c(3,3))

Months = c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

Months.Numeric = c("01","02","03","04","05","06","07","08","09","10","11","12")

 National.Models = 
   which(Scenarios$Essential.Worker.Distancing==0.35 & 
           Scenarios$Vax_Priority=="No Vaccination" &
           Scenarios$Setting=="National" &
           Scenarios$Excess.Risk.Severe == "Mid.RR" )
 

plot(1:ncol(HighMitigation_DailyInc),
     HighMitigation_DailyInc[National.Models[1],],type="l",
     xlim=c(0,2*259),
     xlab="",ylab="Daily Infections per 100k",lwd=2,
     las=1, xaxt="n",font.lab=2, cex.lab = 1.5, font=2)

mtext("National",line=1,font =2, adj=0, cex = 1.5)

axis(side=1,
     at = c(as.numeric(as.Date(paste0("2020-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01")),
            as.numeric(as.Date(paste0("2021-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01"))),
     labels=rep(paste0( Months,"\n1st"),2),
     las=1, tcl=-.25,cex.axis=0.9,font=2)

abline(h=131.5)

for(i in 2:length(National.Models))
{
  lines(1:ncol(HighMitigation_DailyInc),
        HighMitigation_DailyInc[National.Models[i],])
}

rect(xleft=min(StayHome_TransitionDays[["National"]]),
     xright=max(StayHome_TransitionDays[["National"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border =NA)

rect(xleft=min(ReOpen_TransitionDays[["National"]]),
     xright=max(ReOpen_TransitionDays[["National"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)

rect(xleft=Pause.Day[["National"]],
     xright=Pause.Day[["National"]]+15,
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)



abline(v=as.numeric(1+ c(as.Date("2020-12-01"),
                         as.Date("2021-02-01"),
                        as.Date("2021-04-01"))-
                      as.Date("2020-01-01")),lty=2)




plot(1:ncol(HighMitigation_CumulativeInc),
     HighMitigation_CumulativeInc[National.Models[1],],type="l",
     ylim = c(0,17000),xlim=c(0,259),
     xlab="",ylab="Cumulative Incidence",lwd=2,yaxt="n",xaxt="n",font.lab=2, cex.lab = 1.5)

axis(side=1,
     at = c(as.numeric(as.Date(paste0("2020-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01")),
            as.numeric(as.Date(paste0("2021-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01"))),
     labels=rep(paste0( Months,"\n1st"),2),
     las=1, tcl=-.25,cex.axis=0.9,font=2)

axis(side=2,  cex.axis=1.25,
     at=seq(0,100000,5000),
     labels=paste0(seq(0,100,5),"%"),
     las=1,font=2)


for(i in 2:length(National.Models))
{
  lines(1:ncol(HighMitigation_CumulativeInc),
        HighMitigation_CumulativeInc[National.Models[i],])
}

rect(xleft=min(StayHome_TransitionDays[["National"]]),
     xright=max(StayHome_TransitionDays[["National"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border =NA)

rect(xleft=min(ReOpen_TransitionDays[["National"]]),
     xright=max(ReOpen_TransitionDays[["National"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)

rect(xleft=Pause.Day[["National"]],
     xright=Pause.Day[["National"]]+15,
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)








plot(1:ncol(HighMitigation_CumulativeInc),
     R.ts[National.Models[1],],type="l",
     xlim=c(0,259),
     xlab="",ylab="Rt",las=1, xaxt="n",font.lab=2, cex.lab = 1.5,font=2)

axis(side=1,
     at = c(as.numeric(as.Date(paste0("2020-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01")),
            as.numeric(as.Date(paste0("2021-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01"))),
     labels=rep(paste0( Months,"\n1st"),2),
     las=1, tcl=-.25,cex.axis=0.9,font=2)

rect(xleft=min(StayHome_TransitionDays[["National"]]),
     xright=max(StayHome_TransitionDays[["National"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border =NA)

rect(xleft=min(ReOpen_TransitionDays[["National"]]),
     xright=max(ReOpen_TransitionDays[["National"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)

rect(xleft=Pause.Day[["National"]],
     xright=Pause.Day[["National"]]+15,
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)

abline(h=1,lty=2)






JurisdictionA.Models =
  which(Scenarios$Essential.Worker.Distancing==0.35 &
          Scenarios$Vax_Priority=="No Vaccination" &
          Scenarios$Setting=="Jurisdiction A"&
          Scenarios$Excess.Risk.Severe == "Mid.RR" )



plot(1:ncol(HighMitigation_DailyInc),
     HighMitigation_DailyInc[JurisdictionA.Models[1],],type="l",
     xlim=c(0,2*259),
     xlab="",ylab="Daily Infections per 100k",las=1, xaxt="n",font.lab=2, cex.lab = 1.5,font=2, ylim=c(0,100))

mtext("Jurisdiction A",line =1, cex=1.5, font=2, adj=0)
axis(side=1,
     at = c(as.numeric(as.Date(paste0("2020-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01")),
            as.numeric(as.Date(paste0("2021-",
                                      c("01","02","03","04","05","06","07",
                                        "08","09","10","11","12"),  "-01"))-
                         as.Date("2020-01-01"))),
     labels=rep(paste0( Months,"\n1st"),2),
     las=1, tcl=-.25,cex.axis=0.9,font=2)

abline(h=81)

for(i in 2:length(JurisdictionA.Models))
{
  lines(1:ncol(HighMitigation_DailyInc),
        HighMitigation_DailyInc[JurisdictionA.Models[i],])
}

rect(xleft=min(StayHome_TransitionDays[["Jurisdiction A"]]),
     xright=max(StayHome_TransitionDays[["Jurisdiction A"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border =NA)





abline(v=as.numeric(1+c(as.Date("2020-12-01"),
                        as.Date("2021-02-01"),
                        as.Date("2021-04-01"))-
                      as.Date("2020-01-01")),lty=2)




plot(1:ncol(HighMitigation_CumulativeInc),
     HighMitigation_CumulativeInc[JurisdictionA.Models[1],],type="l",
     ylim = c(0,30000),xlim=c(0,259),
     xlab="",ylab="Cumulative Incidence",lwd=2,yaxt="n",font.lab=2, cex.lab = 1.5,xaxt="n")

axis(side=2,  cex.axis=1.25,
     at=seq(0,100000,5000),
     labels=paste0(seq(0,100,5),"%"),
     las=1,font=2)

axis(side=1,
     at = c(as.numeric(as.Date(paste0("2020-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01")),
            as.numeric(as.Date(paste0("2021-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01"))),
     labels=rep(paste0( Months,"\n1st"),2),
     las=1, tcl=-.25,cex.axis=0.9,font=2)

for(i in 2:length(JurisdictionA.Models))
{
  lines(1:ncol(HighMitigation_CumulativeInc),
        HighMitigation_CumulativeInc[JurisdictionA.Models[i],])
}

rect(xleft=min(StayHome_TransitionDays[["Jurisdiction A"]]),
     xright=max(StayHome_TransitionDays[["Jurisdiction A"]]),
     ybottom=-10000,ytop=90E3, col=grey(0.5, 0.5),border =NA)






plot(1:ncol(HighMitigation_CumulativeInc),
     R.ts[JurisdictionA.Models[1],],type="l",
     xlim=c(0,1.5*259),
     xlab="",ylab="Rt",las=1,xaxt="n",font.lab=2, cex.lab = 1.5,font=2)

axis(side=1,
      at = c(as.numeric(as.Date(paste0("2020-",
                                       Months.Numeric,"-01"))-
                          as.Date("2020-01-01")),
             as.numeric(as.Date(paste0("2021-",
                                       Months.Numeric,"-01"))-
                          as.Date("2020-01-01"))),
      labels=rep(paste0( Months,"\n1st"),2),
      las=1, tcl=-.25,cex.axis=0.9,font=2)

 rect(xleft=min(StayHome_TransitionDays[["Jurisdiction A"]]),
      xright=max(StayHome_TransitionDays[["Jurisdiction A"]]),
      ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border =NA)


 abline(h=1,lty=2)









 JurisdictionB.Models =
   which(Scenarios$Essential.Worker.Distancing==0.35 &
           Scenarios$Vax_Priority=="No Vaccination" &
           Scenarios$Setting=="Jurisdiction B"&
           Scenarios$Excess.Risk.Severe == "Mid.RR" )

 plot(1:ncol(HighMitigation_DailyInc),
      HighMitigation_DailyInc[JurisdictionB.Models[1],],type="l",
     ylim = c(0,70),
     xlim=c(0,2*259),
     xlab="",ylab="Daily Infections per 100k",las=1,xaxt="n",font.lab=2, cex.lab = 1.5,font=2)

mtext("Jurisdiction B",line=1,font =2, adj=0,cex=1.5)

axis(side=1,
     at = c(as.numeric(as.Date(paste0("2020-",
                                      Months.Numeric,"-01"))-
                         as.Date("2020-01-01")),
            as.numeric(as.Date(paste0("2021-",
                                      Months.Numeric,"-01"))-
                         as.Date("2020-01-01"))),
     labels=rep(paste0( Months,"\n1st"),2),
     las=1, tcl=-.25,cex.axis=0.9,font=2)


for(i in 2:length(JurisdictionB.Models))
{
  lines(1:ncol(HighMitigation_DailyInc),
        HighMitigation_DailyInc[JurisdictionB.Models[i],])
}

rect(xleft=min(StayHome_TransitionDays[["Jurisdiction B"]]),
     xright=max(StayHome_TransitionDays[["Jurisdiction B"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border =NA)

rect(xleft=min(ReOpen_TransitionDays[["Jurisdiction B"]]),
     xright=max(ReOpen_TransitionDays[["Jurisdiction B"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)

rect(xleft=Pause.Day[["Jurisdiction B"]],
     xright=Pause.Day[["Jurisdiction B"]]+15,
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)



abline(v=as.numeric(1+c(as.Date("2020-12-01"),
                        as.Date("2021-02-01"),
                        as.Date("2021-04-01"))-
                      as.Date("2020-01-01")),lty=2)




plot(1:ncol(HighMitigation_CumulativeInc),
     HighMitigation_CumulativeInc[JurisdictionB.Models[1],],type="l",
     ylim = c(0,13000),
     xlim=c(0,259), xlab="",
     ylab="Cumulative Incidence",lwd=2, yaxt="n",
     font.lab=2, cex.lab = 1.5,xaxt="n")

axis(side=2, at=seq(0,100000,5000),
     labels=paste0(seq(0,100,5),"%"),
     las=1,xaxt="n",font=2,
     cex.axis = 1.25)

axis(side=1,
     at = c(as.numeric(as.Date(paste0("2020-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01")),
            as.numeric(as.Date(paste0("2021-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01"))),
     labels=rep(paste0( Months,"\n1st"),2),
     las=1, tcl=-.25,cex.axis=0.9,font=2)

for(i in 2:length(JurisdictionB.Models))
{
  lines(1:ncol(HighMitigation_CumulativeInc),
        HighMitigation_CumulativeInc[JurisdictionB.Models[i],])
}

rect(xleft=min(StayHome_TransitionDays[["Jurisdiction B"]]),
     xright=max(StayHome_TransitionDays[["Jurisdiction B"]]),
     ybottom=-10000,ytop=90E3, col=grey(0.5, 0.5),border =NA)

rect(xleft=min(ReOpen_TransitionDays[["Jurisdiction B"]]),
     xright=max(ReOpen_TransitionDays[["Jurisdiction B"]]),
     ybottom=-10000,ytop=90E3, col=grey(0.5, 0.5),border=NA)

rect(xleft=Pause.Day[["Jurisdiction B"]],
     xright=Pause.Day[["Jurisdiction B"]]+15,
     ybottom=-10000,ytop=90E3, col=grey(0.5, 0.5),border=NA)







plot(1:ncol(HighMitigation_CumulativeInc),
     R.ts[JurisdictionB.Models[1],],type="l",xlim=c(0,259),
     xlab="",ylab="Rt",las=1,xaxt="n",font.lab=2, cex.lab = 1.5, font =2)

axis(side=1,
     at = c(as.numeric(as.Date(paste0("2020-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01")),
            as.numeric(as.Date(paste0("2021-",
                                      Months.Numeric,  "-01"))-
                         as.Date("2020-01-01"))),
     labels=rep(paste0( Months,"\n1st"),2),
     las=1, tcl=-.25,cex.axis=0.9,font=2)

rect(xleft=min(StayHome_TransitionDays[["Jurisdiction B"]]),
     xright=max(StayHome_TransitionDays[["Jurisdiction B"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border =NA)

rect(xleft=min(ReOpen_TransitionDays[["Jurisdiction B"]]),
     xright=max(ReOpen_TransitionDays[["Jurisdiction B"]]),
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)

rect(xleft=Pause.Day[["Jurisdiction B"]],
     xright=Pause.Day[["Jurisdiction B"]]+15,
     ybottom=-10000,ytop=50E3, col=grey(0.5, 0.5),border=NA)

abline(h=1,lty=2)
```

**Plot Vaccine Introduction Timing Scenarios**

Purple, green, and yellow boxes roughly represent how long it take to
fully vaccinate (both doses) Phase 1 (HCP), the initial targeted portion of phase 2 
(40M courses to one of the 3 priority groups), and the remaining portion of phase 2 
(split proportionally between the 3 priority groups by size, with no subprioritization)

```{r, fig.width = 14, fig.height= 8}

RollingAvg = function(data, window=7)
{
  map_dbl(.x = 1:length(data),
          .f = function(.x){
             mean(data[max(.x-(window-1)/2,1):min(.x+(window-1)/2,length(data))],na.rm=T)
          })
}

par(mar=c(2,3,0,0))

colors= c(brewer.pal(6, "Dark2"),"white")[c(1,2,6,7)]

plot(1:ncol(Prev),
     8*RollingAvg(HighMitigation_DailyInc[intersect(National.Models,
                                                    which(Scenarios$Essential.Worker.Distancing==0.35))[1],]),type="l",
     xlim=c(300,625), #col = colors[1],
     ylim=c(0,1675),
     lty=2,
     axes=F, 
     xlab="", ylab="Prevalence",lwd=3)

axis(side=1, at = seq(366-60,366+240,30), 
     labels = seq(366-60,366+240,30)-366,
     cex.axis=1.5)

abline(v=366, col="black",lty=1)



for(i in 2:length(intersect(National.Models,
                            intersect( 
                              which(Scenarios$Essential.Worker.Distancing==0.35),
                              which(Scenarios$Third.Wave.Peak!="Jun")))))
{
  lines(1:ncol(Prev),
        8*RollingAvg(HighMitigation_DailyInc[intersect(National.Models,
                                                       which(Scenarios$Essential.Worker.Distancing==0.35))[i],]), #col = colors[i],
        lty=2, 
        lwd = 3)
}


lines(1:285, 
      8*RollingAvg(HighMitigation_DailyInc[intersect(National.Models,
                                                     which(Scenarios$Essential.Worker.Distancing==0.35))[1],1:285]), lwd=3)



rect(xleft=366,xright=408,
     ybottom=1555,ytop=1725, col="#440154FF")
rect(xleft=408, xright=479,
     ybottom=1385,ytop=1555, col="#29AF7FFF")
rect(xleft=479,xright=636,
     ybottom=1215,ytop=1385, col = "#FDE725FF")




# axis(side = 2, at = 8*seq(0,150,25),
#      labels = seq(0,150,25), las =1, 
#      cex.axis=1.5)

```

**Calculating Vaccine Impact on Infections and Deaths**

```{r}

Scenarios$Infections.Averted.6months.postIntro = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$Infections.6months.postIntro[index] -
                     Scenarios$Infections.6months.postIntro[.x])
          })


Scenarios$Deaths.Averted.6months.postIntro = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$Deaths.6months.postIntro[index] -
                     Scenarios$Deaths.6months.postIntro[.x])
          })

Scenarios$Deaths.Averted.6months.postIntro.0to49 = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$Deaths.6months.postIntro.0to49[index] -
                     Scenarios$Deaths.6months.postIntro.0to49[.x])
          })

Scenarios$Deaths.Averted.6months.postIntro.50to64 = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$Deaths.6months.postIntro.50to64[index] -
                     Scenarios$Deaths.6months.postIntro.50to64[.x])
          })

Scenarios$Deaths.Averted.6months.postIntro.65plus = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$Deaths.6months.postIntro.65plus[index] -
                     Scenarios$Deaths.6months.postIntro.65plus[.x])
          })



Scenarios$Hospitalizations.Averted.6months.postIntro = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$Hospitalizations.6months.postIntro[index] -
                     Scenarios$Hospitalizations.6months.postIntro[.x])
          })

Scenarios$Hospitalizations.Averted.6months.postIntro.0to49 = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$Hospitalizations.6months.postIntro.0to49[index] -
                     Scenarios$Hospitalizations.6months.postIntro.0to49[.x])
          })

Scenarios$Hospitalizations.Averted.6months.postIntro.50to64 = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$Hospitalizations.6months.postIntro.50to64[index] -
                     Scenarios$Hospitalizations.6months.postIntro.50to64[.x])
          })

Scenarios$Hospitalizations.Averted.6months.postIntro.65plus = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$Hospitalizations.6months.postIntro.65plus[index] -
                     Scenarios$Hospitalizations.6months.postIntro.65plus[.x])
          })

Scenarios$YLL.Averted.6months.postIntro = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(Scenarios$YLL.6months.postIntro[index] -
                     Scenarios$YLL.6months.postIntro[.x])
          })

Scenarios$Percent.Infections.Averted.6months.postIntro = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$Infections.Averted.6months.postIntro[.x]/Scenarios$Infections.6months.postIntro[index])
          })

Scenarios$Percent.Deaths.Averted.6months.postIntro = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$Deaths.Averted.6months.postIntro[.x]/Scenarios$Deaths.6months.postIntro[index])
          })

Scenarios$Percent.Deaths.Averted.6months.postIntro.0to49 = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$Deaths.Averted.6months.postIntro.0to49[.x]/Scenarios$Deaths.6months.postIntro.0to49[index])
          })

Scenarios$Percent.Deaths.Averted.6months.postIntro.50to64 = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$Deaths.Averted.6months.postIntro.50to64[.x]/Scenarios$Deaths.6months.postIntro.50to64[index])
          })

Scenarios$Percent.Deaths.Averted.6months.postIntro.65plus = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$Deaths.Averted.6months.postIntro.65plus[.x]/Scenarios$Deaths.6months.postIntro.65plus[index])
          })

Scenarios$Percent.Hospitalizations.Averted.6months.postIntro = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$Hospitalizations.Averted.6months.postIntro[.x]/Scenarios$Hospitalizations.6months.postIntro[index])
          })

Scenarios$Percent.Hospitalizations.Averted.6months.postIntro.0to49 = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$Hospitalizations.Averted.6months.postIntro.0to49[.x]/Scenarios$Hospitalizations.6months.postIntro.0to49[index])
          })

Scenarios$Percent.Hospitalizations.Averted.6months.postIntro.50to64 = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$Hospitalizations.Averted.6months.postIntro.50to64[.x]/Scenarios$Hospitalizations.6months.postIntro.50to64[index])
          })

Scenarios$Percent.Hospitalizations.Averted.6months.postIntro.65plus = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$Hospitalizations.Averted.6months.postIntro.65plus[.x]/Scenarios$Hospitalizations.6months.postIntro.65plus[index])
          })

Scenarios$Percent.YLL.Averted.6months.postIntro = 
  map_dbl(.x=1:nrow(Scenarios), 
          .f = function(.x){
            index = which(Scenarios$Setting==Scenarios$Setting[.x] &
                            Scenarios$Vax_Priority=="No Vaccination"&
                            Scenarios$Essential.Worker.Distancing==
                            Scenarios$Essential.Worker.Distancing[.x]&
                            Scenarios$Third.Wave.Peak==Scenarios$Third.Wave.Peak[.x]&
                            Scenarios$Excess.Risk.Severe == Scenarios$Excess.Risk.Severe[.x]   
            )
            
            return(100*Scenarios$YLL.Averted.6months.postIntro[.x]/Scenarios$YLL.6months.postIntro[index])
          })

Scenarios$Third.Wave.Peak =
  Scenarios$Third.Wave.Peak %>%
  replace(list=which(Scenarios$Third.Wave.Peak=="Jun"),"5 Months Before") %>%
  replace(list=which(Scenarios$Third.Wave.Peak=="Apr"),"3 Months Before") %>%
  replace(list=which(Scenarios$Third.Wave.Peak=="Feb"),"1 Month Before") %>%
  replace(list=which(Scenarios$Third.Wave.Peak=="Dec"),"1 Month After")

Scenarios$Third.Wave.Peak = 
  factor(Scenarios$Third.Wave.Peak, 
         levels = c("1 Month Before","1 Month After"))


Scenarios$Percent.All.Deaths.Averted.6months.postIntro.0to49 =
  Scenarios$Percent.Deaths.Averted.6months.postIntro*
  (Scenarios$Deaths.Averted.6months.postIntro.0to49/Scenarios$Deaths.Averted.6months.postIntro)

Scenarios$Percent.All.Deaths.Averted.6months.postIntro.50to64 =
  Scenarios$Percent.Deaths.Averted.6months.postIntro*
  (Scenarios$Deaths.Averted.6months.postIntro.50to64/Scenarios$Deaths.Averted.6months.postIntro)

Scenarios$Percent.All.Deaths.Averted.6months.postIntro.65plus =
  Scenarios$Percent.Deaths.Averted.6months.postIntro*
  (Scenarios$Deaths.Averted.6months.postIntro.65plus/Scenarios$Deaths.Averted.6months.postIntro)

Scenarios$Percent.All.Deaths.Averted.6months.postIntro.0to64 = 
  Scenarios$Percent.All.Deaths.Averted.6months.postIntro.0to49 + 
  Scenarios$Percent.All.Deaths.Averted.6months.postIntro.50to64


Scenarios$Percent.All.Hospitalizations.Averted.6months.postIntro.0to49 =
  Scenarios$Percent.Hospitalizations.Averted.6months.postIntro*
  (Scenarios$Hospitalizations.Averted.6months.postIntro.0to49/Scenarios$Hospitalizations.Averted.6months.postIntro)

Scenarios$Percent.All.Hospitalizations.Averted.6months.postIntro.50to64 =
  Scenarios$Percent.Hospitalizations.Averted.6months.postIntro*
  (Scenarios$Hospitalizations.Averted.6months.postIntro.50to64/Scenarios$Hospitalizations.Averted.6months.postIntro)

Scenarios$Percent.All.Hospitalizations.Averted.6months.postIntro.65plus =
  Scenarios$Percent.Hospitalizations.Averted.6months.postIntro*
  (Scenarios$Hospitalizations.Averted.6months.postIntro.65plus/Scenarios$Hospitalizations.Averted.6months.postIntro)

Scenarios$Percent.All.Hospitalizations.Averted.6months.postIntro.0to64 = 
  Scenarios$Percent.All.Hospitalizations.Averted.6months.postIntro.0to49 + 
  Scenarios$Percent.All.Hospitalizations.Averted.6months.postIntro.50to64
```


## Impact of Vaccination: Averted Infections {.tabset .tabset-pills}

### Full Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

```{r}
par(mar=c(5,5.6,2,0.1))

light.colors = 
  map_chr(.x = colors, 
          .f = function(.x)
          {
            RGB = col2rgb(.x)[,1]
            return(rgb(RGB["red"], 
                       RGB["green"], 
                       RGB["blue"],
                       alpha=255*2/3,
                       maxColorValue = 255))
          })

lightest.colors = 
  map_chr(.x = colors, 
          .f = function(.x)
          {
            RGB = col2rgb(.x)[,1]
            return(rgb(RGB["red"], 
                       RGB["green"], 
                       RGB["blue"],
                       alpha=255*1/3,
                       maxColorValue = 255))
          })

for(i in unique(Scenarios$Setting)[1])
{ 
  a=barplot(Percent.Infections.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
 
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Infections Averted by Vaccination\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

  
}


legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Infections.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c("As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c("1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises",
                "As Incidence Falls"),
       font =2,
       cex.axis=0.85, tcl = 0)

  axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

  if(i == unique(Scenarios$Setting)[2])
  {mtext("% Infections Averted by Vaccination\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

### Half Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  a=barplot(Percent.Infections.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
 
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Infections Averted by Vaccination\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Infections.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c(
                                         "1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises",
                "As Incidence Falls"),
       font =2,
       cex.axis=0.85, tcl = 0)

  axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

  if(i == unique(Scenarios$Setting)[2])
  {mtext("% Infections Averted by Vaccination\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}


}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```


## Impact of Vaccination: Averted Deaths (Infection-Blocking Vaccine) {.tabset .tabset-pills}

### Full Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

All ages

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  DAT = Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)
  
    a=barplot(Percent.Deaths.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c("As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =DAT )
    
     # barplot(Percent.All.Deaths.Averted.6months.postIntro.0to64 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = lightest.colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
     #      barplot(Percent.All.Deaths.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
  

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 0-49

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 0-49 Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
  

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 50-64

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.50to64 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 50-64 Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
  

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

Age 65+
```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.65plus ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 65+ Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
  

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Deaths.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c(
                                         "1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises",
                "As Incidence Falls"),
       font =2,
       cex.axis=0.85, tcl = 0)

  axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

  if(i == unique(Scenarios$Setting)[2])
  {mtext("% Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}


}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

### Half Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

All ages 

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  DAT = Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)
  
    a=barplot(Percent.Deaths.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3], #light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c("As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =DAT )
    
     # barplot(Percent.All.Deaths.Averted.6months.postIntro.0to64 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = lightest.colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
     #      barplot(Percent.All.Deaths.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

Age 0-49

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 0-49 Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
  

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 50-64

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.50to64 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 50-64 Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
  

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 65+
```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.65plus ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 65+ Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Deaths.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c(
                                         "1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


axis(side=1,
     at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
     labels=c(
              "As Incidence Rises",
              "As Incidence Falls"),
     font =2,
     cex.axis=0.85, tcl = 0)

axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

if(i == unique(Scenarios$Setting)[2])
{mtext("% Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

## Impact of Vaccination: Averted Deaths (Disease-Blocking Vaccine) {.tabset .tabset-pills}

### Full Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

All ages

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  DAT = Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)
  
    a=barplot(Percent.Deaths.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c("As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =DAT )
    
     # barplot(Percent.All.Deaths.Averted.6months.postIntro.0to64 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = lightest.colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
     #      barplot(Percent.All.Deaths.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 0-49

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 0-49 Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 50-64

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.50to64 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 50-64 Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 65+
```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.65plus ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 65+ Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Deaths.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c(
                                         "1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises",
                "As Incidence Falls"),
       font =2,
       cex.axis=0.85, tcl = 0)

  axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

  if(i == unique(Scenarios$Setting)[2])
  {mtext("% Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}


legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")


```

### Half Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

All ages

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  DAT = Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)
  
    a=barplot(Percent.Deaths.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c("As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =DAT )
    
     # barplot(Percent.All.Deaths.Averted.6months.postIntro.0to64 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = lightest.colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
     #      barplot(Percent.All.Deaths.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 0-49

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 0-49 Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 50-64

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.50to64 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 50-64 Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 65+
```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Deaths.Averted.6months.postIntro.65plus ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 65+ Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```


#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Deaths.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c(
                                         "1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises",
                "As Incidence Falls"),
       font =2,
       cex.axis=0.85, tcl = 0)

  axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

  if(i == unique(Scenarios$Setting)[2])
  {mtext("% Deaths Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```


## Impact of Vaccination: Averted Hospitalizations (Infection-Blocking Vaccine) {.tabset .tabset-pills}

### Full Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

All ages

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  DAT = Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)
  
    a=barplot(Percent.Hospitalizations.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c("As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =DAT )
    
     # barplot(Percent.All.Hospitalizations.Averted.6months.postIntro.0to64 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = lightest.colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
     #      barplot(Percent.All.Hospitalizations.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 0-49

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 0-49 Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 50-64

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.50to64 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 50-64 Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.05)}
  

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 65+
```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.65plus ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 65+ Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```




#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c(
                                         "1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises",
                "As Incidence Falls"),
       font =2,
       cex.axis=0.85, tcl = 0)

  axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

  if(i == unique(Scenarios$Setting)[2])
  {mtext("% Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

### Half Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

All ages 

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  DAT = Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)
  
    a=barplot(Percent.Hospitalizations.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c("As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =DAT )
    
     # barplot(Percent.All.Hospitalizations.Averted.6months.postIntro.0to64 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = lightest.colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
     #      barplot(Percent.All.Hospitalizations.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 0-49

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 0-49 Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

Age 50-64

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.50to64 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 50-64 Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}
  
 
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 65+
```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.65plus ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 65+ Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```



#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c(
                                         "1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises",
                "As Incidence Falls"),
       font =2,
       cex.axis=0.85, tcl = 0)

  axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

  if(i == unique(Scenarios$Setting)[2])
  {mtext("% Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```


## Impact of Vaccination: Averted Hospitalizations (Disease-Blocking Vaccine) {.tabset .tabset-pills}

### Full Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

All ages

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  DAT = Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)
  
    a=barplot(Percent.Hospitalizations.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c("As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =DAT )

     # barplot(Percent.All.Hospitalizations.Averted.6months.postIntro.0to64 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = lightest.colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
     #      barplot(Percent.All.Hospitalizations.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

Age 0-49

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 0-49 Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}
  

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

Age 50-64

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.50to64 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 50-64 Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.05)}
  
  

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

Age 65+
```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.65plus ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 65+ Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}
  
  

  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Full",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c(
                                         "1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises",
                "As Incidence Falls"),
       font =2,
       cex.axis=0.85, tcl = 0)

  axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

  if(i == unique(Scenarios$Setting)[2])
  {mtext("% Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```


### Half Efficacy in Older Adults (65+) {.tabset .tabset-pills}

#### National

All ages

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  DAT = Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)
  
    a=barplot(Percent.Hospitalizations.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c("As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =DAT )
    
     # barplot(Percent.All.Hospitalizations.Averted.6months.postIntro.0to64 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = lightest.colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
     # 
     #      barplot(Percent.All.Hospitalizations.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
     #        beside = T,
     #        xaxt="n",
     #        xlab= "Vaccine Introduction Time",
     #        col = colors[1:3],
     #        ylab="", las=1,
     #        main = 
     #          switch(i,"National"= "", "Jurisdiction A" = "High Burden", 
     #                 "Jurisdiction B" = "Low Burden"),
     #        ylim = c(0,35), font=2,
     #        cex.names = 0.4,
     #        names.arg= c("As Incidence Rises",
     #                     "As Incidence Falls"),
     #        font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
     #        data =DAT , add=T)
     # 
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}
  
  

  
}


legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

Age 0-49

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.0to49 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 0-49 Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```

Age 50-64

```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.50to64 ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 50-64 Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}
  
 
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

Age 65+
```{r}
par(mar=c(5,5.6,2,0.1))

for(i in unique(Scenarios$Setting)[1])
{ 
  
  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro.65plus ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main = 
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden", 
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,35), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data = 
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Disease Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%  
              mutate(Third.Wave.Peak = 
                       factor(Third.Wave.Peak, 
                              levels = c( 
                                         "1 Month Before", 
                                         "1 Month After")),
                     Vax_Priority = 
                       factor(Vax_Priority, 
                              levels = 
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak)) 
  
  
  
  
  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises", 
                "As Incidence Falls"), 
       font =2, 
       cex.axis=0.85, tcl = 0)
  
  axis(side=2, at =seq(0,35,5), labels = paste0(seq(0,35,5),"%"),font=2, las=2,cex.axis=1.2)
  
  if(i == unique(Scenarios$Setting)[1])
  {mtext("% of Age 65+ Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.1)}
  
}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")

```

#### Jurisdictions A and B

```{r}
par(mar=c(5,5.6,2,0.1),
    mfrow=c(1,2))

for(i in unique(Scenarios$Setting)[2:3])
{

  a=barplot(Percent.Hospitalizations.Averted.6months.postIntro ~ Vax_Priority + Third.Wave.Peak,
            beside = T,
            xaxt="n",
            xlab= "Vaccine Introduction Time",
            col = light.colors[1:3],
            ylab="", las=1,
            main =
              switch(i,
                     "National"= "",
                     "Jurisdiction A" = "High Burden",
                     "Jurisdiction B" = "Low Burden"),
            ylim = c(0,50), font=2,
            cex.names = 0.4,
            names.arg= c(
                         "As Incidence Rises",
                         "As Incidence Falls"),
            font.lab=2, yaxt="n",cex.lab=1.2,#cex = 1.25,cex.lab=1.2,
            data =
              Scenarios %>%
              filter(Setting==i,
                     Immunogenicity.Elderly == "Half",
                     Essential.Worker.Distancing==0.35,
                     Mode.of.Action=="Infection Blocking",
                     Excess.Risk.Severe == "Mid.RR",
                     Third.Wave.Peak != "5 Months Before") %>%
              mutate(Third.Wave.Peak =
                       factor(Third.Wave.Peak,
                              levels = c(
                                         "1 Month Before",
                                         "1 Month After")),
                     Vax_Priority =
                       factor(Vax_Priority,
                              levels =
                                c("Elderly",
                                  "HighRisk",
                                  "Essential"))) %>%
              arrange(Third.Wave.Peak))


  axis(side=1,
       at=a[2,], #(a[2,]-a[1,])*0.5+a[1,],
       labels=c(
                "As Incidence Rises",
                "As Incidence Falls"),
       font =2,
       cex.axis=0.85, tcl = 0)

  axis(side=2, at =seq(0,50,5), labels = paste0(seq(0,50,5),"%"),font=2, las=2,cex.axis=1.2)

  if(i == unique(Scenarios$Setting)[2])
  {mtext("% Hospitalizations Averted by Vaccine\n(6 Months Following Introduction)",side=2,line=3.5, font=2, cex = 1.2)}

}

legend("topright",
       legend = c("Age 65+",
                  "High-Risk Conditions",
                  "Essential Workers"),
       fill = colors,
       title = "Initial Phase 1B Target")
```